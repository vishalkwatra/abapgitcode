sap.ui.define([                                                                                                                                                                                                                                                
	"./BaseController",                                                                                                                                                                                                                                           
	"sap/ui/model/json/JSONModel",                                                                                                                                                                                                                                
	"sap/ui/model/Filter",                                                                                                                                                                                                                                        
	"sap/ui/model/FilterOperator",                                                                                                                                                                                                                                
	"../model/formatter"                                                                                                                                                                                                                                          
], function (BaseController, JSONModel, Filter, FilterOperator, formatter) {                                                                                                                                                                                   
	"use strict";                                                                                                                                                                                                                                                 
	var oSmartTableGlobal;                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                               
	return BaseController.extend("ey.sap.fin.cs.profitrecon.controller.PTAEntries", {                                                                                                                                                                             
		formatter: formatter,                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                               
		onInit: function () {                                                                                                                                                                                                                                        
			this.oRouter = this.getOwnerComponent().getRouter();                                                                                                                                                                                                        
			this.oRouter.getRoute("PTAEntries").attachMatched(this._onRouteMatched, this);                                                                                                                                                                              
                                                                                                                                                                                                                                                               
			oSmartTableGlobal = this.getView().byId("idPTATableDrillDown");                                                                                                                                                                                             
		},                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
		_onRouteMatched: function () {                                                                                                                                                                                                                               
			this.ptaEntriesConfigModel = this.getOwnerComponent().getModel("PTAEntryConfigData");                                                                                                                                                                       
			if (this.ptaEntriesConfigModel && this.ptaEntriesConfigModel.getData()) {                                                                                                                                                                                   
				oSmartTableGlobal.rebindTable();                                                                                                                                                                                                                           
			} else { // Screen refreshed - Navigate to main screen                                                                                                                                                                                                      
				let oRouter = this.getRouter();                                                                                                                                                                                                                            
				this.getBusyDialog().open();                                                                                                                                                                                                                               
				oRouter.navTo("profitrecon", {}, true);                                                                                                                                                                                                                    
			}                                                                                                                                                                                                                                                           
		},                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
		onBeforeRebindPTADrillDown: function (oEvent) {                                                                                                                                                                                                              
			//  When page is refreshed - table is rendered and rebind is also triggered. Hence getting error in console as data model is not available                                                                                                                  
			//	Below condition prevents the above issue                                                                                                                                                                                                                 
			if (!this.ptaEntriesConfigModel) {                                                                                                                                                                                                                          
				return;                                                                                                                                                                                                                                                    
			}                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
			let PTAEntryData = this.ptaEntriesConfigModel.getData(),                                                                                                                                                                                                    
				oFilter, aUserFilter = oEvent.getParameter("bindingParams").filters,                                                                                                                                                                                       
				oBindingParams = oEvent.getParameter("bindingParams"),                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
				iPeriodToValue = PTAEntryData.SelectedIntention === '' ? PTAEntryData.PeriodTo : PTAEntryData.SelectedIntention,                                                                                                                                           
				aMandFilters = [new Filter("GLAccount", FilterOperator.EQ, PTAEntryData.GLAccount),                                                                                                                                                                        
					new Filter("ConsolidationUnit", FilterOperator.EQ, PTAEntryData.ConsolidationUnit),                                                                                                                                                                       
					// new Filter("FiscalPeriod", FilterOperator.BT, PTAEntryData.PeriodFrom, iPeriodToValue),                                                                                                                                                                
					new Filter("FiscalPeriod", FilterOperator.BT, PTAEntryData.PeriodFrom, PTAEntryData.PeriodTo),                                                                                                                                                            
					new Filter("FiscalYear", FilterOperator.EQ, PTAEntryData.FiscalYear),                                                                                                                                                                                     
					new Filter("TaxIntention", FilterOperator.LE, PTAEntryData.SelectedIntention)                                                                                                                                                                             
				];                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                               
			// if user filters available - add them to mandatory filters.                                                                                                                                                                                               
			if (aUserFilter.length > 0) {                                                                                                                                                                                                                               
				//  Using the spread operator to concat the array content.                                                                                                                                                                                                 
				aMandFilters = [...aMandFilters, ...aUserFilter];                                                                                                                                                                                                          
			}                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
			oFilter = new Filter({                                                                                                                                                                                                                                      
				filters: aMandFilters,                                                                                                                                                                                                                                     
				and: true                                                                                                                                                                                                                                                  
			});                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                               
			oSmartTableGlobal.setTableBindingPath("/xEY1xSAV_C_Rec_PTA");                                                                                                                                                                                               
			oBindingParams.filters = [oFilter];                                                                                                                                                                                                                         
		},                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
		_onAdjustPTADrillDownCol: function () {                                                                                                                                                                                                                      
			var oTable = this.getView().byId("idPTATableDrillDown").getTable();                                                                                                                                                                                         
			var aCols = oTable.getColumns();                                                                                                                                                                                                                            
			for (var i = aCols.length - 1; i >= 0; i--) {                                                                                                                                                                                                               
				oTable.autoResizeColumn(i);                                                                                                                                                                                                                                
			}                                                                                                                                                                                                                                                           
		},                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
		// ----------------------------------------------- EVENT HANDLERS -------------------------------------------------------                                                                                                                                    
		onPressDocumentNumberLinkPTADisplay: function (oEvent) {                                                                                                                                                                                                     
			this.getBusyDialog().open();                                                                                                                                                                                                                                
			this.oRouter.navTo("DisplayPTA", {                                                                                                                                                                                                                          
				docId: oEvent.getSource().getText()                                                                                                                                                                                                                        
			});                                                                                                                                                                                                                                                         
		},                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
		onDataReceivedPTADrillDown: function (oEvent) {                                                                                                                                                                                                              
			this.getBusyDialog().open();                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                               
			let oView = this.getView(),                                                                                                                                                                                                                                 
				oTITextColumn = oView.byId("idPTATaxIntentionDesc"),                                                                                                                                                                                                       
				oTIItemColumn = oView.byId("idPTATaxIntention");                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
			var oIntervalCall = window.setInterval(function (e) {                                                                                                                                                                                                       
				this._onAdjustPTADrillDownCol();                                                                                                                                                                                                                           
				if (oTIItemColumn.getGrouped()) {                                                                                                                                                                                                                          
					oTITextColumn.setVisible(true);                                                                                                                                                                                                                           
				} else {                                                                                                                                                                                                                                                   
					oTITextColumn.setVisible(false);                                                                                                                                                                                                                          
				}                                                                                                                                                                                                                                                          
				this.getBusyDialog().close();                                                                                                                                                                                                                              
				window.clearInterval(oIntervalCall);                                                                                                                                                                                                                       
			}.bind(this), 1000);                                                                                                                                                                                                                                        
		}                                                                                                                                                                                                                                                            
	});                                                                                                                                                                                                                                                           
});                                                                                                                                                                                                                                                            