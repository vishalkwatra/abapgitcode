sap.ui.define(["./BaseController","sap/ui/model/json/JSONModel","sap/m/MessageToast","sap/m/MessageBox","sap/ui/model/Filter","sap/ui/model/FilterOperator","../model/formatter","sap/ui/core/routing/History","sap/ui/generic/app/navigation/service/Navigati+
onHandler"],function(e,t,n,r,i,a,s,o,l){"use strict";let g=sap.ui.getCore();const d="Original",u="Create",c="Update";return e.extend("ey.sap.fin.cs.managetiers.controller.Tiers",{formatter:s,onInit:function(){let e=this.getView(),n=new t({edit:false}),r=+
new t,i=new t;this.oNavigationHandler=new l(this);e.byId("idHeadText").setText(this.getResourceBundle().getText("tiersTableTitle",[0]));e.setModel(n,"editTierModel");e.setModel(r,"deleteModel");e.setModel(i,"message");if(!this.oMessagePopover){this.oMess+
agePopover=sap.ui.xmlfragment("ey.sap.fin.cs.managetiers.fragment.MessagePopover",this);this.oView.addDependent(this.oMessagePopover)}this.bAllEntriesValidated=true;this.oRouter=this.getOwnerComponent().getRouter();this.oRouter.getRoute("TargetTiers").at+
tachMatched(this._onRouteMatched,this)},_onRouteMatched:function(e){let t=this,n=this.getView(),i=false;this.getOwnerComponent().getService("ShellUIService").then(function(e){e.setBackNavigation(t._onPressShellNavBack.bind(t))});var a=this.oNavigationHan+
dler.parseNavigation();a.done(function(e,r,a){if(a!==sap.ui.generic.app.navigation.service.NavType.initial){if(r.Country&&r.Country[0]){n.byId("idFilterCountryCode").setSelectedKey(r.Country);i=true}else{i=false}if(r.FiscalYear&&r.FiscalYear[0]){n.byId("+
idFilterFiscalYear").setValue(r.FiscalYear);i=true}else{i=false}if(r.Intention&&r.Intention[0]){let e=[r.Country,r.FiscalYear];t._fetchIntentionStatus(e);n.byId("idIntentionComboBox").setSelectedKey(r.Intention);i=true}else{i=false}}if(i){t._fetchTiersDa+
ta()}});a.fail(jQuery.proxy(function(e,n,i){r.error(t.getI18nText("navigationError"))},this))},_fetchIntentionStatus:function(e){let n=this.getModel();let s=e[0],o=e[1],l="/xEY1xSAV_C_IntentionsStatus(p_bunit='"+s+"')/Set",g=new i("Gjahr",a.EQ,o),d=this;+
this.getBusyDialog().open();n.read(l,{method:"GET",sorters:[new sap.ui.model.Sorter("SerialNumber")],filters:[g],success:function(e,n){d.getBusyDialog().close();e.results.splice(e.results.map(e=>e.Intention).indexOf("PER"),1);let r=new t(e);d.getView().s+
etModel(r,"intentionVHModel")},error:function(e){d.getBusyDialog().close();r.error(d.getI18nText("errorFetchingIntentions"))}})},_manageIntentionStatus:function(e){let t=this;if(e.status==="Closed"){this._disableButton(false);return}else if(e.status===th+
is.getI18nText("YetToOpen")){t.getBusyDialog().close();this._disableButton(false);return}else if(e.status==="Open"){this._disableButton(true)}},_disableButton:function(e){},_onPressShellNavBack:function(){let e=false,t=this.getView().byId("idTiersTable")+
.getModel("tiersTableModel");if(t){let i=t.getData().results,a=jQuery.extend(true,[],this._getOriginalTiersData().getData());if(i.length===a.length){for(var n=0;n<i.length;n++){for(var r=0;r<a.length;r++){if(i[n].CountryKey===a[r].CountryKey&&i[n].Fiscal+
Year===a[r].FiscalYear&&i[n].Intention===a[r].Intention&&parseInt(i[n].Sequence,[10])===parseInt(a[r].Sequence,[10])&&(i[n].TierAmount!==a[r].TierAmount||i[n].TaxRate!==a[r].TaxRate)){e=true}}}}else if(i.length<a.length){e=true}else if(i.length>a.length)+
{e=true}else{e=false}if(e){this._unsavedChangesWarning()}else{window.history.go(-1)}}else{window.history.go(-1)}},_unsavedChangesWarning:function(){let e=this.getResourceBundle().getText("btnTextLeavePage");r.warning(this.getResourceBundle().getText("err+
orMsgLeaveManageTiersScreen"),{actions:[e,r.Action.CANCEL],emphasizedAction:e,onClose:function(t){if(t===e){window.history.go(-1)}}})},_getMaxTier:function(e){let t=1;if(e.results.length>0){t=Math.max(...e.results.map(e=>parseInt(e.Sequence,[10])))+1}ret+
urn String(t)},_fetchTiersData:function(){let e=this.getView(),n=this.getOwnerComponent().getModel(),s=e.byId("idTiersTable"),o=e.byId("idEditToggleBtn"),l=e.byId("idFilterFiscalYear").getValue(),g=e.byId("idFilterCountryCode").getSelectedItem().getBindi+
ngContext().getObject().Country,u=e.byId("idIntentionComboBox").getSelectedKey(),c=this,h=new i({filters:[new i("CountryKey",a.EQ,g),new i("FiscalYear",a.EQ,l),new i("Intention",a.EQ,u)],and:true});this.getBusyDialog().open();o.setEnabled(true);n.read("/+
xEY1xSAV_C_TIERS",{filters:[h],sorters:[new sap.ui.model.Sorter("Sequence")],method:"GET",success:function(e){c.getBusyDialog().close();e.results.map(e=>{e.editFlag=d});s.setModel(new t(e),"tiersTableModel");s.getModel("tiersTableModel").setDefaultBindin+
gMode("TwoWay");c.getView().byId("idHeadText").setText(c.getResourceBundle().getText("tiersTableTitle",[s.getBinding("items").getLength()]));c._setOriginalTiersData(e)},error:function(e){c.getBusyDialog().close();r.error(c.getI18nText("TierGetServiceCall+
Error"))}})},_closeMessagePopovers:function(){if(this.oMessagePopover){this.oMessagePopover.close()}},_setOriginalTiersData:function(e){let n=jQuery.extend(true,[],e.results);n.map(e=>delete e.__metadata);this.getView().setModel(new t(n),"modelOriginalTi+
ersData")},_getOriginalTiersData:function(){return this.getView().getModel("modelOriginalTiersData")},_setUpdatedEntries:function(e,t){let n=e.getSource(),r=n.getValue(),i=n.getParent().getBindingContextPath(),a=n.getModel("tiersTableModel"),s=new RegExp+
(/[^0-9.-]/gi),o=new RegExp(/.*\..*\..*/),l,g,d,u=this.getView().byId("idFilterCountryCode").getSelectedItem().getBindingContext().getObject().Currency;if(t==="TierAmount"){d=u}else{d="%"}l=r.toUpperCase().indexOf(d);if(l>=0){let e=r.replace(/\s/g,"");g=+
e.substr(0,e.length-d.length)}else{g=r}if(s.exec(g)!==null){n.setValue("");this._validateInvalidEntry(e,t);return}if(o.exec(g)!==null){n.setValue("");this._validateInvalidEntry(e,t);return}let h=n.getParent().getBindingContext("tiersTableModel").getObjec+
t();a.setProperty(i+"/"+t,r.toUpperCase());if(h.editFlag===c){a.setProperty(i+"/editFlag",c)}this._validateInvalidEntry(e,t)},_setUpdatedFragmentAmount:function(e,t){let n=e.getSource(),r=n.getValue(),i=new RegExp(/[^0-9.-]/gi),a=new RegExp(/.*\..*\..*/)+
,s,o,l,g,d=this.getView().byId("idFilterCountryCode").getSelectedItem().getBindingContext().getObject().Currency;if(t==="TierAmount"){l=d}else{l="%"}s=r.toUpperCase().indexOf(l);if(s>=0){let e=r.replace(/\s/g,"");o=e.substr(0,e.length-l.length)}else{o=r}+
if(i.exec(o)!==null){n.setValue("");this._validateInvalidEntry(e,t);return}if(a.exec(o)!==null){n.setValue("");this._validateInvalidEntry(e,t);return}if(t==="TaxRate"){g=this.formatter.appendPercentageSign(r)}else{g=this.formatter.formatTierAmountDisplay+
AndEdit(r,true,l)}n.setValue(g);this._validateInvalidEntry(e,t)},_validateInvalidEntry:function(e,t){let n=e.getSource(),r=n.getValue();if(t==="TaxRate"&&(!r||parseFloat(r,[10])<0||parseFloat(r,[10])>100)){n.setValueState("Error");this.bAllEntriesValidat+
ed=false;return}n.setValueState("None");this.bAllEntriesValidated=true;if(!r||parseFloat(r,[10])===0){n.setValueState("Error");this.bAllEntriesValidated=false}},_setScreenToDisplayMode:function(){let e=this.getView();e.getModel("deleteModel").setData([])+
;e.getModel("editTierModel").setProperty("/edit",false);this._fetchTiersData()},_clearMessagesPopover:function(){let e=this.getView().getModel("message");e.setData([]);e.refresh();g.getMessageManager().removeAllMessages()},getI18nText:function(e){return +
this.getResourceBundle().getText(e)},_serviceCallDeleteTiers:function(e){let t=this.getOwnerComponent().getModel(),r=this;for(var i=0;i<e.length;i++){let n="/xEY1xSAV_C_TIERS(CountryKey='"+e[i].CountryKey+"',FiscalYear='"+e[i].FiscalYear+"',Intention='"++
e[i].Intention+"',Sequence='"+e[i].Sequence+"')";t.remove(n,{groupId:"groupIdRollOver"})}return new Promise(function(e,i){t.submitChanges({groupId:"groupIdRollOver",success:function(t,a){let s;if(!t.__batchResponses){r._setScreenToDisplayMode();i(t);retu+
rn}s=t.__batchResponses[0].__changeResponses;if(!s||s.length<=0){r._setScreenToDisplayMode();i(t);return}let o=JSON.parse(s.find(e=>e.headers["sap-message"]).headers["sap-message"]);if(o&&o.severity.toUpperCase()==="SUCCESS"){e(t)}else if(o&&o.message){n+
.show(r.getI18nText("genericMsgBatchRollOverError"));i(t)}},error:function(e){r._setScreenToDisplayMode();i(oData)}})})},_sServiceCreateTiers:function(e){let t=this.getOwnerComponent().getModel(),r=this.getView().byId("idTiersTable").getModel("tiersTable+
Model").getData().results,i=this,a=[];if(r.length>0){e.map(e=>{r.map(t=>{t.TierAmount=parseFloat(t.TierAmount,[10]).toFixed(2);delete t.__metadata;delete t.editFlag;delete t.Tier;t.TaxRate=parseFloat(t.TaxRate).toFixed(2);var n=Object.assign({},t,{Intent+
ion:e.Intent});a.push(n)})});for(var s=0;s<a.length;s++){t.create("/xEY1xSAV_C_TIERS",a[s],{groupId:"groupIdRollOver"})}t.submitChanges({groupId:"groupIdRollOver",success:function(e,t){let r;if(!e.__batchResponses){i._setScreenToDisplayMode();return}r=e.+
__batchResponses[0].__changeResponses;if(!r||r.length<=0){i._setScreenToDisplayMode();return}let a=JSON.parse(r.find(e=>e.headers["sap-message"]).headers["sap-message"]);if(a&&a.severity.toUpperCase()==="SUCCESS"){n.show(i.getI18nText("genericMsgBatchRol+
lOverSuccess"));i._setScreenToDisplayMode()}else if(a&&a.message){n.show(i.getI18nText("genericMsgBatchError"))}},error:function(e){i._setScreenToDisplayMode()}})}else{n.show(i.getI18nText("genericMsgBatchRollOverSuccess"))}},onChangeDatePickerFilter:fun+
ction(e){let t=e.getSource(),n=this.getView().byId("idFilterCountryCode").getSelectedKey();if(e.getParameter("valid")){t.setValueState("None");let e=t.getDateValue().getFullYear(),r=[n,e];this._fetchIntentionStatus(r)}else{t.setValueState("Error")}},onPr+
essAddNewTier:function(e){let t=this.getView();if(!this._oTierCreateFragment){this._oTierCreateFragment=sap.ui.xmlfragment("tierCreate","ey.sap.fin.cs.managetiers.fragment.TierCreate",this);t.addDependent(this._oTierCreateFragment)}this._oTierCreateFragm+
ent.open();let n=t.byId("idTiersTable").getModel("tiersTableModel").getData(),r=this._getMaxTier(n);g.byId("tierCreate--IdTier").setText("Tier "+r);let i=g.byId("tierCreate--IdTierAmnt"),a=g.byId("tierCreate--IdTaxRate");i.setValue("");a.setValue("");i.s+
etValueState("None");a.setValueState("None")},onPressDeleteTier:function(){let e=this.getView(),r=e.byId("idTiersTable"),i=r.getSelectedItems();if(!i.length){return}let a=e.getModel("deleteModel"),s=r.getModel("tiersTableModel"),o=[],l=r.getModel("tiersT+
ableModel").getData(),g=new t;if(r.getSelectedItems().length===r.getItems().length){let e=[];l.results.map(t=>{if(t.editFlag!==u){e.push(t)}});g.setData([]);g.setData(e);s.setData({results:[]})}else{g.setData({});o=i.map(e=>r.indexOfItem(e));o.sort(funct+
ion(e,t){return t-e});for(var d=0;d<o.length;d++){let e=parseInt(this._getMaxTier(l),[10])-1;if(e>parseInt(l.results[o[d]].Sequence,[10])){n.show(this.getI18nText("deletTierError"));break}else{let e=l.results.splice(o[d],1),t=g.getData();if(e[0].editFlag+
!==u){delete e[0].editFlag;if(Object.keys(t).length===0&&t.constructor===Object){t=e}else{t.push(e[0])}}g.setData(t);s.setData(l);s.refresh()}}}let c=a.getData();if(Object.keys(c).length===0&&c.constructor===Object){c=g.getData()}else{for(var h=0;h<g.get+
Data().length;h++){c.push(g.getData()[h])}}a.setData(c);s.refresh()},onPressCloseDialog:function(){this._oTierCreateFragment.close()},onPressEditToggleBtn:function(e){let t=this.getView();t.getModel("editTierModel").setProperty("/edit",true);this._clearM+
essagesPopover()},onPressSaveBtnAddTier:function(){let e=g.byId("tierCreate--IdTierAmnt"),t=e.getValue(),n=g.byId("tierCreate--IdTaxRate"),r=n.getValue();if(!t){e.setValueState("Error")}else if(!r){n.setValueState("Error")}if(e.getValueState()==="Error"|+
|n.getValueState()==="Error"){return}let i=this.getView(),a=i.byId("idTiersTable").getModel("tiersTableModel"),s=g.byId("tierCreate--IdTier").getText(),o=i.byId("idFilterFiscalYear").getValue(),l=i.byId("idFilterCountryCode").getSelectedItem().getBinding+
Context().getObject().Country,h=i.byId("idFilterCountryCode").getSelectedItem().getBindingContext().getObject().Currency,f=i.byId("idIntentionComboBox").getSelectedKey(),p=a.getData(),T=this._getMaxTier(p),I=i.getModel("deleteModel").getData(),y={Country+
Key:l,FiscalYear:o,Sequence:T,Tier:s,TierAmount:t,TaxRate:r,editFlag:u,LocalCurrency:h,Intention:f};for(var S=0;S<I.length;S++){if(I[S].CountryKey===y.CountryKey&&I[S].FiscalYear===y.FiscalYear&&I[S].Intention===y.Intention&&parseInt(I[S].Sequence,[10])=+
==parseInt(y.Sequence,[10])&&parseFloat(I[S].TierAmount).toFixed(2)===parseFloat(y.TierAmount).toFixed(2)||parseFloat(I[S].TaxRate).toFixed(2)===parseFloat(y.TaxRate).toFixed(2)){I.splice(S,1);y.editFlag=d}else if(I[S].CountryKey===y.CountryKey&&I[S].Fis+
calYear===y.FiscalYear&&I[S].Intention===y.Intention&&parseInt(I[S].Sequence,[10])===parseInt(y.Sequence,[10])){I.splice(S,1);y.editFlag=c}}p.results.push(y);a.setData(p);a.refresh();this._oTierCreateFragment.close()},onSearchButtonPressed:function(){thi+
s._fetchTiersData()},onChangeTierTaxRate:function(e){this._setUpdatedEntries(e,"TaxRate")},onChangeTierAmount:function(e){this._setUpdatedEntries(e,"TierAmount")},onPressSaveTier:function(){if(!this.bAllEntriesValidated){r.error(this.getI18nText("errorMs+
gInvalidTableData"));return}let e=this.getOwnerComponent(),t=e.getModel(),i=this,a=this.getView().byId("idTiersTable").getModel("tiersTableModel").getData().results,s=jQuery.extend(true,[],this._getOriginalTiersData().getData());this._clearMessagesPopove+
r();s.map(e=>{e.TierAmount=parseFloat(e.TierAmount,[10]).toFixed(2);delete e.__metadata;delete e.editFlag;delete e.Tier;e.TaxRate=parseFloat(e.TaxRate).toFixed(2);return e});a.map(e=>{e.TierAmount=parseFloat(e.TierAmount,[10]).toFixed(2);delete e.__metad+
ata;delete e.editFlag;delete e.Tier;e.TaxRate=parseFloat(e.TaxRate).toFixed(2);return e});t.setUseBatch(true);t.setChangeGroups({"/SAV_MANAGE_TIER_SRV":{groupId:"groupIdSaveTier",changeSetId:"ID",single:false}});t.setDeferredGroups(t.getDeferredGroups().+
concat(["groupIdSaveTier"]));if(a.length>s.length){let e=a.filter(e=>s.filter(t=>parseInt(t.Sequence,[10])===parseInt(e.Sequence,[10])&&t.CountryKey===e.CountryKey&&t.FiscalYear===e.FiscalYear&&t.Intention===e.Intention&&(t.TaxRate!==e.TaxRate||t.TierAmo+
unt!==e.TierAmount)).length>0);if(e.length>0){for(var o=0;o<e.length;o++){let n="/xEY1xSAV_C_TIERS(CountryKey='"+e[o].CountryKey+"',FiscalYear='"+e[o].FiscalYear+"',Intention='"+e[o].Intention+"',Sequence='"+e[o].Sequence+"')";t.update(n,e[o],{groupId:"g+
roupIdSaveTier"})}}let n=a.filter(e=>s.filter(t=>t.CountryKey===e.CountryKey&&t.FiscalYear===e.FiscalYear&&t.Intention===e.Intention&&parseInt(t.Sequence,[10])===parseInt(e.Sequence,[10])).length===0);if(n.length>0){for(var l=0;l<n.length;l++){t.create("+
/xEY1xSAV_C_TIERS",n[l],{groupId:"groupIdSaveTier"})}}}else if(a.length===s.length){for(var o=0;o<a.length;o++){for(var g=0;g<s.length;g++){if(a[o].CountryKey===s[g].CountryKey&&a[o].FiscalYear===s[g].FiscalYear&&a[o].Intention===s[g].Intention&&parseInt+
(a[o].Sequence,[10])===parseInt(s[g].Sequence,[10])&&(a[o].TierAmount!==s[g].TierAmount||a[o].TaxRate!==s[g].TaxRate)){t.update("/xEY1xSAV_C_TIERS(CountryKey='"+a[o].CountryKey+"',FiscalYear='"+a[o].FiscalYear+"',Intention='"+a[o].Intention+"',Sequence='+
"+a[o].Sequence+"')",a[o],{groupId:"groupIdSaveTier"})}}}}else if(a.length<s.length){let e=a.filter(e=>s.filter(t=>parseInt(t.Sequence,[10])===parseInt(e.Sequence,[10])&&t.CountryKey===e.CountryKey&&t.FiscalYear===e.FiscalYear&&t.Intention===e.Intention&+
&(t.TaxRate!==e.TaxRate||t.TierAmount!==e.TierAmount)).length>0);if(e.length>0){for(var o=0;o<e.length;o++){let n="/xEY1xSAV_C_TIERS(CountryKey='"+e[o].CountryKey+"',FiscalYear='"+e[o].FiscalYear+"',Intention='"+e[o].Intention+"',Sequence='"+e[o].Sequenc+
e+"')";t.update(n,e[o],{groupId:"groupIdSaveTier"})}}let n=s.filter(e=>a.filter(t=>parseInt(t.Sequence,[10])===parseInt(e.Sequence,[10])&&t.CountryKey===e.CountryKey&&t.FiscalYear===e.FiscalYear&&t.Intention===e.Intention).length===0);if(n.length>0){for(+
var o=0;o<n.length;o++){let e="/xEY1xSAV_C_TIERS(CountryKey='"+n[o].CountryKey+"',FiscalYear='"+n[o].FiscalYear+"',Intention='"+n[o].Intention+"',Sequence='"+n[o].Sequence+"')";t.remove(e,{groupId:"groupIdSaveTier"})}}}else{let e=this.getView();e.getMode+
l("deleteModel").setData([]);e.getModel("editTierModel").setProperty("/edit",false);return}t.submitChanges({groupId:"groupIdSaveTier",success:function(e,t){let r;if(!e.__batchResponses){i._setScreenToDisplayMode();return}r=e.__batchResponses[0].__changeR+
esponses;if(!r||r.length<=0){i._setScreenToDisplayMode();return}let a=JSON.parse(r.find(e=>e.headers["sap-message"]).headers["sap-message"]);if(a&&a.severity.toUpperCase()==="SUCCESS"){n.show(i.getI18nText("genericMsgBatchSuccess"));i._setScreenToDisplay+
Mode()}else if(a&&a.message){n.show(i.getI18nText("genericMsgBatchError"))}},error:function(e){i._setScreenToDisplayMode()}})},onPressCancelTier:function(){let e=this.getView(),t=e.byId("idTiersTable");e.getModel("deleteModel").setData([]);e.getModel("ed+
itTierModel").setProperty("/edit",false);t.getModel("tiersTableModel").setData({results:jQuery.extend(true,[],this._getOriginalTiersData().getData())});t.removeSelections();this._closeMessagePopovers();this._clearMessagesPopover()},onPressHandleMessagePo+
pover:function(e){},onChangeTierAmountFragment:function(e){this._setUpdatedFragmentAmount(e,"TierAmount")},onChangeTaxRateFragment:function(e){this._setUpdatedFragmentAmount(e,"TaxRate")},onChangeIntention:function(){let e=this.getView().byId("idSmartFil+
terBar"),t=e.validateMandatoryFields();if(t){let t=this.getView().byId("idIntentionComboBox").getSelectedItem(),n=t.getBindingContext("intentionVHModel").getObject();this._manageIntentionStatus(n);e.fireSearch()}},onPressRollOver:function(e){let t=this.g+
etView(),n=t.byId("idIntentionComboBox").getSelectedKey(),s=t.getModel("intentionVHModel").getData().results,o=s.findIndex(e=>e.Intent===n),l=s.slice(o+1),g=this.getOwnerComponent().getModel(),d=t.byId("idFilterFiscalYear").getValue(),u=t.byId("idFilterC+
ountryCode").getSelectedItem().getBindingContext().getObject().Country,c=this,h=[],f,p=new i({filters:[new i("CountryKey",a.EQ,u),new i("FiscalYear",a.EQ,d)],and:true});g.setUseBatch(true);g.setChangeGroups({"/SAV_MANAGE_TIER_SRV":{groupId:"groupIdRollOv+
er",changeSetId:"ID",single:false}});g.setDeferredGroups(g.getDeferredGroups().concat(["groupIdRollOver"]));if(l.length>0){g.read("/xEY1xSAV_C_TIERS",{filters:[p],sorters:[new sap.ui.model.Sorter("Sequence")],method:"GET",success:function(e){l.map(t=>{e.+
results.map(e=>{if(e.Intention===t.Intent){h.push(e)}})});if(h.length>0){f=c._serviceCallDeleteTiers(h,l);f.then(function(e){c._sServiceCreateTiers(l)},function(e){r.error(c.getI18nText("genericMsgBatchRollOverError"))})}else{c._sServiceCreateTiers(l)}},+
error:function(e){r.error(c.getI18nText("TierGetServiceCallError"))}})}else{r.error(c.getI18nText("errorMsgInvalidIntention"))}}})});                                                                                                                          