sap.ui.define(["./BaseController","sap/ui/model/json/JSONModel","../model/formatter","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/m/MessageToast","sap/m/MessageBox","sap/ui/core/ListItem"],function(e,t,n,i,o,r,a,s){"use strict";return e.exten+
d("ey.sap.fin.cs.deferredtaxrollfwd.controller.MainReport",{formatter:n,onInit:function(){this.oRouter=this.getOwnerComponent().getRouter();this.oRouter.getRoute("mainreport").attachMatched(this._onRouteMatched,this);this._fetchGlobalParameters();this._f+
etchAdjustmentReasons();this.getView().setModel(new t({results:[{key:"RGAAP",text:this.getI18nText("sBtnTextReportingGAAP")},{key:"SGAAP",text:this.getI18nText("sBtnTextStatutoryReporting")}]}),"modelReportingType")},_onRouteMatched:function(){this.getBu+
syDialog().close();this.oGlobalSmartTable=this.getView().byId("idTRFMainRepSmartTable");this.bTriggerDTRFService=true;this.oGlobalSmartTable.getTable().setFixedColumnCount(3)},_fetchGlobalParameters:function(){var e=this;var n=this.getOwnerComponent().ge+
tModel();let i=new t;this.setModel(i,"viewConfigDataModel");n.callFunction("/GlobalParameter",{method:"GET",success:function(t){e.getView().getModel("viewConfigDataModel").setData({globalParameters:t});let n=e.getView().byId("idTRFMainRepSmartFilterBar")+
;if(!n.getCurrentVariantId()){e._setFilterBarParameters(t)}},error:function(t){a.error(e.getI18nText("errorReadingGlobalParameters"))}})},_setFilterBarParameters:function(e){let t=this.getView(),i=t.byId("idCurrency");if(e.ConsolidationUnit){t.byId("idCo+
nsUnit").setSelectedKey(e.ConsolidationUnit);i.setVisible(true);this._fetchCurrencyData(true);this.fetchReconLedgerData()}if(e.FiscalYear){let n=new Date("06/06/".concat(e.FiscalYear.toString()));t.byId("idFiscalYearFilter").setDateValue(n)}if(e.Intentio+
n){t.byId("idIntentionComboBox").setSelectedKey(e.Intention)}var o=[e.ConsolidationUnit,e.FiscalYear];this._fetchIntentionStatus(o);if(e.PeriodFrom){t.byId("idPeriodFromInput").setValue(n.convertStringToInt(e.PeriodFrom))}if(e.PeriodTo){t.byId("idPeriodT+
oInput").setValue(n.convertStringToInt(e.PeriodTo))}if(e.LocalCurrencyType&&e.LocalCurrency){i.setSelectedKey(e.LocalCurrency)}else{i.setSelectedKey(e.GroupCurrency)}if(e.ConsolidationUnit&&e.FiscalYear&&e.Intention){this._fetchValidTaxRates({Consolidati+
onUnit:e.ConsolidationUnit,PeriodTo:e.PeriodTo,FiscalYear:e.FiscalYear})}},_fetchAdjustmentReasons:function(){let e=this.getOwnerComponent().getModel();let t="/xEY1xSAV_C_Recon_Adj_Reason";let n=this;e.read(t,{method:"GET",success:function(e,t){var i=n.g+
etModel("viewConfigDataModel");i.getData().adjustmentReason=e.results;i.refresh()},error:function(e){if(parseInt(e.statusCode,[10])!==404){r.show(n.getI18nText("adjReasonServiceCallError"))}}})},getI18nText:function(e){return this.getResourceBundle().get+
Text(e)},_fetchCurrencyData:function(e){var n=this.getView(),r=n.byId("idConsUnit").getSelectedKey(),a=new i("ConsolidationUnit",o.EQ,r),s=this.getModel(),l=this,d=n.byId("idCurrType"),g=n.byId("idCurrency");d.setVisible(true);g.setBusy(true);s.read("/xE+
Y1xSAV_C_CurrLocalGroupVH",{method:"GET",filters:[a],success:function(n,i){g.setBusy(false);l.setModel(new t(n),"currLocalGroupVHModel");if(!e&&n.results.length>0){g.setSelectedKey(n.results[0].Currency)}},error:function(e){g.setBusy(false)}})},_fetchInt+
entionStatus:function(e){let n=this.getModel();let r=e[0],s=e[1],l="/xEY1xSAV_C_IntentionsStatus(p_bunit='"+r+"')/Set",d=new i("Gjahr",o.EQ,s),g=this,u=g.getView(),c=u.byId("idIntentionComboBox");this.getBusyDialog().open();n.read(l,{method:"GET",sorters+
:[new sap.ui.model.Sorter("SerialNumber")],filters:[d],success:function(e,n){g.getBusyDialog().close();if(e.results.length===0){c.setSelectedKey("");c.setEnabled(false);a.error(g.getI18nText("IntentionNotYetOpen")+s);return}c.setEnabled(true);let i=g.get+
View().getModel("viewConfigDataModel").getData().globalParameters;c.setSelectedKey(i.Intention);let o=new t(e);g.getView().setModel(o,"intentionVHModel");g._managePeriodFieldsEditability(false)},error:function(e){g.getBusyDialog().close();a.error(g.getI1+
8nText("errorFetchingIntentionStatus"))}})},_managePeriodFieldsEditability:function(e){let t=this.getView(),i=t.byId("idIntentionComboBox");if(!e){i.setSelectedKey(i.getSelectedKey())}let o=i.getSelectedItem(),r=o.getBindingContext("intentionVHModel").ge+
tObject();let a=t.byId("idPeriodToInput"),s=n.convertStringToInt(r.TaxIntention);if(s!==n.convertStringToInt(0)){this._manageIntentionStatus(r);a.setEditable(false);a.setValue(n.convertStringToInt(r.PeriodTo))}else{this._managePerodicIntentionStatus(r.Pe+
riodTo);a.setEditable(true);a.setValue(n.convertStringToInt(r.CurrOpenPeriod))}},_manageIntentionStatus:function(e){let t=this;if(e.status===this.getI18nText("YetToOpen")){t.getBusyDialog().close();a.error(e.IntentDescription+" "+t.getI18nText("ThisInten+
tionNotYetOpen")+e.Gjahr);return}else{return}},_managePerodicIntentionStatus:function(e){let t=this.getView().byId("idIntentionComboBox").getSelectedItem().getBindingContext("intentionVHModel").getObject(),n=parseInt(t.CurrOpenPeriod,[10]);if(e>n){this.g+
etBusyDialog().close();a.error(this.getModel("i18n").getResourceBundle().getText("errorPeriodnotopen",[e,n]));return}else{return}},_createJournalEntriesFilterData:function(e){let t=e.getSource().getBindingContext();if(!t.getProperty("GLAccount")){return}+
let i=this.getModel("viewConfigDataModel").getData(),o=this.getView().byId("idFiscalYearFilter"),r=o.getDateValue().getFullYear(),a=parseInt(this.getView().byId("idPeriodFromInput").getValue(),[10]),s=parseInt(this.getView().byId("idPeriodToInput").getVa+
lue(),[10]),l=this.getView().byId("idConsUnit"),d=this.getView().byId("idCurrency"),g=this.getView().byId("idIntentionComboBox").getSelectedItem().getBindingContext("intentionVHModel").getObject(),u=n.convertStringToInt(g.PeriodTo)===0?"":n.convertString+
ToInt(g.TaxIntention),c=t.getProperty("GLAccount").padStart(10,"0"),h=[],f=false;let I=[],T=this.getView().byId("idTRFMainRepSegmentedBtn").getSelectedKey();if(T==="RGAAP"){I=[i.reconData.g2s,i.reconData.s2t]}else{I=[i.reconData.s2t]}let y=e.getSource().+
getCustomData();for(let e of y){let t=e.getValue();let n=e.getKey();if(n==="mappedAdjReason"){for(let e=0;e<i.adjustmentReason.length;e++){if(i.adjustmentReason[e].AdjustmentReason===t){h.push(i.adjustmentReason[e].TransType);break}}continue}if(n==="mapp+
edIsOpeningBalanceEntry"){f=true}}let b=e.getSource().getBindingInfo("text").parts,C=b[b.map(e=>e.path.indexOf("MainCurrency")!==0).indexOf(true)].path;let m=this.serviceDataProperty.property;m=m[m.map(e=>e.name).indexOf(C)];let p=m.extensions;p=p[p.map(+
e=>e.name).indexOf("label")];return{ConsolidationChartOfAccounts:i.globalParameters.ConsolidationChartofAccounts,FiscalYear:r,PeriodFrom:a,PeriodTo:s,ConsolidatioUnit:l.getSelectedKey(),ConsolidationLedger:I,FinancialTransactionType:h,Value:t.getProperty+
(C),Currency:t.getProperty("MainCurrency"),GLAccount:c,ConsolidationVersion:"",SelectedIntention:u,ConsolidationGroup:"",PeriodMode:"PER",RefConsolidationDocumentType:"W",selectedCurrency:d.getSelectedKey(),SectionName:p.value,GLAccountDesc:t.getProperty+
("GLAccountMdmText"),bIsOpeningBalanceEntry:f}},_fetchValidTaxRates:function(e){e=e?e:{};let t=this,n=this.getView(),o=n.byId("idConsUnit").getSelectedKey(),s=n.byId("idIntentionComboBox").getSelectedItem(),l=n.byId("idFiscalYearFilter").getDateValue(),d+
=this.getModel();if(!s){return}let g=e.ConsolidationUnit?e.ConsolidationUnit:o,u=e.PeriodTo?e.PeriodTo:s.getBindingContext("intentionVHModel").getObject().PeriodTo,c=e.FiscalYear?e.FiscalYear:l.getFullYear();if(!g||!u||!c){return}let h="/xEY1xSAV_C_Fetch+
_Tax_Rates(p_toperiod='"+u+"',p_ryear='"+c+"')/Set";d.read(h,{method:"GET",filters:[new i("ConsolidationUnit","EQ",g)],success:function(e){t.bTriggerDTRFService=true;if(e.results.length<1){a.error(t.getI18nText("errorTaxRatesNotMaintained"));t.bTriggerDT+
RFService=false}},error:function(e){r.show(t.getI18nText("warningFetchingTaxRates"));t.bTriggerDTRFService=false}})},onBeforeRebindTable:function(e){if(!this.bTriggerDTRFService){let e="/xEY1xSAV_C_DeferredTaxRollFrwd(p_rbunit='GB02',p_toperiod='12',p_ry+
ear='2999',p_taxintention='')/Results";this.oGlobalSmartTable.setTableBindingPath(e);a.error(this.getI18nText("errorTaxRatesNotMaintained"));return}let t=this.getView(),n=t.getModel("viewConfigDataModel").getData();if(!n.globalParameters||!n.globalParame+
ters.ConsolidationChartofAccounts||!n.globalParameters.ConsolidationGroup){a.error(this.getI18nText("errorMaintainGlobalParameter"));return}let r=t.byId("idConsUnit"),s=r.getSelectedKey(),l=t.byId("idCurrency"),d=l.getSelectedKey(),g=t.byId("idFiscalYear+
Filter"),u=g.getDateValue().getFullYear(),c=t.byId("idPeriodToInput"),h=parseInt(c.getValue(),[10]),f,I,T;if(t.byId("idIntentionComboBox").getEnabled()===false){a.error(this.getI18nText("IntentionNotYetOpen")+u);this.oGlobalSmartTable.setTableBindingPath+
("");return}let y=t.byId("idIntentionComboBox").getSelectedItem().getBindingContext("intentionVHModel"),b=y.getObject(),C=parseInt(b.CurrOpenPeriod,[10]);if(b.status===this.getI18nText("YetToOpen")){this.getBusyDialog().close();a.error(b.IntentDescriptio+
n+" "+this.getI18nText("ThisIntentionNotYetOpen")+b.Gjahr);this.oGlobalSmartTable.setTableBindingPath("");return}if(h>C){this.getBusyDialog().close();a.error(this.getModel("i18n").getResourceBundle().getText("errorPeriodnotopen",[h,C]));this.oGlobalSmart+
Table.setTableBindingPath("");return}let m=parseInt(b.TaxIntention,[10]),p=m>12?m:"",S=this.getView().byId("idTRFMainRepSegmentedBtn").getSelectedKey();f=new i({filters:[new i("ConsolidationUnit",o.EQ,s),new i("ChartOfAccounts",o.EQ,"CANA"),new i("Consol+
idationChartofAccounts",o.EQ,n.globalParameters.ConsolidationChartofAccounts),new i("MainCurrency",o.EQ,d),new i("ReportingType",o.EQ,S)],and:true});T=f;if(e.getParameter("bindingParams").filters.length>0){I=new i({filters:e.getParameter("bindingParams")+
.filters});T=new i({filters:[f,I],and:true})}let x="/xEY1xSAV_C_DeferredTaxRollFrwd(p_rbunit='"+s+"',p_toperiod='"+h+"',p_ryear='"+u+"',p_taxintention='"+p+"')/Results";this.oGlobalSmartTable.setTableBindingPath(x);let P=e.getParameter("bindingParams");P+
.filters=[T]},onBeforeVariantSaveFilterBar:function(e){let t=this.getView(),n=t.byId("idTRFMainRepSmartFilterBar"),i=t.byId("idConsUnit"),o=t.byId("idFiscalYearFilter"),r=t.byId("idIntentionComboBox"),a=t.byId("idCurrency"),s=t.byId("idPeriodToInput");n.+
setFilterData({_CUSTOM:{ConsolidationUnit:i.getSelectedKey(),FiscalYear:o.getValue(),Intention:r.getSelectedKey(),CurrType:a.getSelectedKey(),PeriodTo:s.getValue(),VariantID:n.getCurrentVariantId()}})},onAfterVariantLoadFilterBar:function(e){var t=this.g+
etView();var i=t.byId("idTRFMainRepSmartFilterBar");var o=t.byId("idConsUnit");var r=t.byId("idFiscalYearFilter");let a=t.byId("idIntentionComboBox");var s=t.byId("idCurrency");let l=this.getView().byId("idPeriodToInput");var d=i.getFilterData()["_CUSTOM+
"];o.setSelectedKey(d.ConsolidationUnit);r.setValue(d.FiscalYear);a.setSelectedKey(d.Intention);s.setSelectedKey(d.CurrType);l.setValue(n.convertStringToInt(d.PeriodTo));if(d.ConsolidationUnit){this.fetchReconLedgerData()}if(d.CurrType){s.setVisible(true+
);this._fetchCurrencyData(true)}if(d.ConsolidationUnit&&d.FiscalYear&&d.Intention){this._fetchValidTaxRates({ConsolidationUnit:d.ConsolidationUnit,PeriodTo:d.PeriodTo,FiscalYear:d.FiscalYear})}},onSearchButtonPressed:function(e){let t=this.getModel().get+
ServiceMetadata().dataServices.schema[0].entityType;this.serviceDataProperty=t.find(e=>e.name==="xEY1xSAV_C_DeferredTaxRollFrwdResults")},onSearch:function(e){if(e.getParameters().refreshButtonPressed){this.onRefresh()}else{var t=[];var n=e.getParameter(+
"query");if(n&&n.length>0){t=[new i("GLAccount",o.Contains,n)]}this._applySearch(t)}},onDataReceivedSmartTable:function(e){this.getBusyDialog().open();this.oGlobalSmartTable.getTable().setVisibleRowCount(10);var t=window.setInterval(function(){this.onAdj+
ustTableCol();window.clearInterval(t)}.bind(this),1e3)},onAdjustTableCol:function(){let e=this.oGlobalSmartTable;var t=e.getTable();var n=t.getColumns();for(var i=n.length-1;i>=0;i--){t.autoResizeColumn(i)}this.getBusyDialog().close()},onChangeDatePicker+
Filter:function(e){let t=e.getSource(),n=this.getModel("viewConfigDataModel").getData(),i=n.globalParameters.ConsolidationUnit;if(e.getParameter("valid")){t.setValueState("None");let e=t.getDateValue().getFullYear(),n=[i,e];this._fetchIntentionStatus(n)}+
else{t.setValueState("Error")}if(e.getSource().getValue()){this._fetchValidTaxRates()}},onConsUnitChange:function(e){this._fetchCurrencyData(false);this.fetchReconLedgerData();if(e.getSource().getValue()){this._fetchValidTaxRates()}},onChangeIntentionCom+
boBox:function(e){let t=this.getView(),n=t.byId("idIntentionComboBox"),i=n.getSelectedItem();if(!i){n.setSelectedItem("");return}this._managePeriodFieldsEditability(true);if(e.getSource().getValue()){this._fetchValidTaxRates()}},fetchReconLedgerData:func+
tion(){let e=this.getModel();let t=e.createKey("/xEY1xSAV_C_Recon_Ledger",{bunit:this.byId("idConsUnit").getSelectedKey()});let n=this;e.read(t,{method:"GET",success:function(e,t){var i=n.getModel("viewConfigDataModel");i.getData().reconData=e;i.refresh(+
)},error:function(e){if(parseInt(e.statusCode,[10])!==404){r.show(n.getI18nText("reconServiceCallError"))}}})},onLiveChangePeriodTo:function(){let e=this.getView().byId("idPeriodToInput");let t=parseInt(this.getView().byId("idPeriodFromInput").getValue()+
,[10]);let n=parseInt(e.getValue(),[10]);e.setValueState("None");if(n<t){e.setValueState("Error");e.setValueStateText(this.getI18nText("periodToLessThanPeriodFromErrorMsg"));return}else if(n>"012"){e.setValueState("Error");e.setValueStateText(this.getI18+
nText("periodToGreaterThanLastPeriod"));return}else{this._managePerodicIntentionStatus(n)}},onPressColumnMenuOpenGLAccount:function(e){let t=e.getParameter("menu").getPopup();t.attachOpened(function(e){let t=e.getSource().getContent().getAggregation("ite+
ms");let n=t.map(e=>e.getId().toString().indexOf("menu-freeze")!==-1).indexOf(true);t[n].setEnabled(false)})},onPressTRFEntryDetails:function(e){var n=this._createJournalEntriesFilterData(e);if(!n){return}var i=new t(n);this.getOwnerComponent().setModel(+
i,"JournalEntryData");this.oRouter.navTo("JournalEntries")},onChangeButtonReportingType:function(e){let t=this.getView().byId("idTRFMainRepSmartFilterBar");if(t.validateMandatoryFields()){t.fireSearch()}}})});                                              