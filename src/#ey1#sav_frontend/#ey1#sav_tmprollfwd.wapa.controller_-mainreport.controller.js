sap.ui.define(["./BaseController","sap/ui/model/json/JSONModel","../model/formatter","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/m/MessageToast","sap/m/MessageBox","sap/ui/core/ListItem"],function(e,t,n,i,o,r,a,s){"use strict";return e.exten+
d("ey.sap.fin.cs.temporaryrollfwd.controller.MainReport",{formatter:n,onInit:function(){this.oRouter=this.getOwnerComponent().getRouter();this.oRouter.getRoute("mainreport").attachMatched(this._onRouteMatched,this);this._fetchGlobalParameters();this._fet+
chAdjustmentReasons();this.getView().setModel(new t({results:[{key:"RGAAP",text:this.getI18nText("sBtnTextReportingGAAP")},{key:"SGAAP",text:this.getI18nText("sBtnTextStatutoryReporting")}]}),"modelReportingType")},_onRouteMatched:function(){this.getBusy+
Dialog().close();this.oGlobalSmartTable=this.getView().byId("idTRFMainRepSmartTable");this.oGlobalSmartTable.getTable().setFixedColumnCount(3)},_fetchGlobalParameters:function(){var e=this;var n=this.getOwnerComponent().getModel();let i=new t;this.setMod+
el(i,"viewConfigDataModel");n.callFunction("/GlobalParameter",{method:"GET",success:function(t){e.getView().getModel("viewConfigDataModel").setData({globalParameters:t});let n=e.getView().byId("idTRFMainRepSmartFilterBar");if(!n.getCurrentVariantId()){e.+
_setFilterBarParameters(t)}},error:function(t){a.error(e.getI18nText("errorReadingGlobalParameters"))}})},_setFilterBarParameters:function(e){let t=this.getView(),i=t.byId("idCurrency");if(e.ConsolidationUnit){t.byId("idConsUnit").setSelectedKey(e.Consol+
idationUnit);i.setVisible(true);this._fetchCurrencyData(true);this.fetchReconLedgerData()}if(e.FiscalYear){let n=new Date("06/06/".concat(e.FiscalYear.toString()));t.byId("idFiscalYearFilter").setDateValue(n)}if(e.Intention){t.byId("idIntentionComboBox")+
.setSelectedKey(e.Intention)}var o=[e.ConsolidationUnit,e.FiscalYear];this._fetchIntentionStatus(o);if(e.PeriodFrom){t.byId("idPeriodFromInput").setValue(n.convertStringToInt(e.PeriodFrom))}if(e.PeriodTo){t.byId("idPeriodToInput").setValue(n.convertStrin+
gToInt(e.PeriodTo))}if(e.LocalCurrencyType&&e.LocalCurrency){i.setSelectedKey(e.LocalCurrency)}else{i.setSelectedKey(e.GroupCurrency)}if(e.ConsolidationUnit&&e.FiscalYear&&e.Intention){this._fetchValidTaxRates({ConsolidationUnit:e.ConsolidationUnit,Perio+
dTo:e.PeriodTo,FiscalYear:e.FiscalYear})}},_fetchAdjustmentReasons:function(){let e=this.getOwnerComponent().getModel();let t="/xEY1xSAV_C_Recon_Adj_Reason";let n=this;e.read(t,{method:"GET",success:function(e,t){var i=n.getModel("viewConfigDataModel");i+
.getData().adjustmentReason=e.results;i.refresh()},error:function(e){if(parseInt(e.statusCode,[10])!==404){r.show(n.getI18nText("adjReasonServiceCallError"))}}})},getI18nText:function(e){return this.getResourceBundle().getText(e)},_fetchCurrencyData:func+
tion(e){var n=this.getView(),r=n.byId("idConsUnit").getSelectedKey(),a=new i("ConsolidationUnit",o.EQ,r),s=this.getModel(),l=this,d=n.byId("idCurrType"),g=n.byId("idCurrency");d.setVisible(true);g.setBusy(true);s.read("/xEY1xSAV_C_CurrLocalGroupVH",{meth+
od:"GET",filters:[a],success:function(n,i){g.setBusy(false);l.setModel(new t(n),"currLocalGroupVHModel");if(!e&&n.results.length>0){g.setSelectedKey(n.results[0].Currency)}},error:function(e){g.setBusy(false)}})},_fetchIntentionStatus:function(e){let n=t+
his.getModel();let r=e[0],s=e[1],l="/xEY1xSAV_C_IntentionsStatus(p_bunit='"+r+"')/Set",d=new i("Gjahr",o.EQ,s),g=this,u=g.getView(),c=u.byId("idIntentionComboBox");this.getBusyDialog().open();n.read(l,{method:"GET",sorters:[new sap.ui.model.Sorter("Seria+
lNumber")],filters:[d],success:function(e,n){g.getBusyDialog().close();if(e.results.length===0){c.setSelectedKey("");c.setEnabled(false);a.error(g.getI18nText("IntentionNotYetOpen")+s);return}c.setEnabled(true);let i=g.getView().getModel("viewConfigDataM+
odel").getData().globalParameters;c.setSelectedKey(i.Intention);let o=new t(e);g.getView().setModel(o,"intentionVHModel");g._managePeriodFieldsEditability(false)},error:function(e){g.getBusyDialog().close();a.error(g.getI18nText("errorFetchingIntentionSt+
atus"))}})},_managePeriodFieldsEditability:function(e){let t=this.getView(),i=t.byId("idIntentionComboBox");if(!e){i.setSelectedKey(i.getSelectedKey())}let o=i.getSelectedItem(),r=o.getBindingContext("intentionVHModel").getObject();let a=t.byId("idPeriod+
ToInput"),s=n.convertStringToInt(r.TaxIntention);if(s!==n.convertStringToInt(0)){this._manageIntentionStatus(r);a.setEditable(false);a.setValue(n.convertStringToInt(r.PeriodTo))}else{this._managePerodicIntentionStatus(r.PeriodTo);a.setEditable(true);a.se+
tValue(n.convertStringToInt(r.CurrOpenPeriod))}},_manageIntentionStatus:function(e){let t=this;if(e.status===this.getI18nText("YetToOpen")){t.getBusyDialog().close();a.error(e.IntentDescription+" "+t.getI18nText("ThisIntentionNotYetOpen")+e.Gjahr);return+
}else{return}},_managePerodicIntentionStatus:function(e){let t=this.getView().byId("idIntentionComboBox").getSelectedItem().getBindingContext("intentionVHModel").getObject(),n=parseInt(t.CurrOpenPeriod,[10]);if(e>n){this.getBusyDialog().close();a.error(t+
his.getModel("i18n").getResourceBundle().getText("errorPeriodnotopen",[e,n]));return}else{return}},_fetchCnsldVersion:function(){let e=this.getModel(),n=this.getModel("viewConfigDataModel").getData(),i=n.globalParameters.ConsolidationGroup,o="/xEY1xSAV_C+
_Get_Version(p_congr='"+i+"')/Set",a=this,s=new t;sap.ui.getCore().setModel(s,"viewCnlVersionModel");e.read(o,{method:"GET",sorters:[new sap.ui.model.Sorter("FiscalYear")],success:function(e,t){sap.ui.getCore().getModel("viewCnlVersionModel").setData({Co+
nsolidationVersion:e})},error:function(e){if(parseInt(e.statusCode,[10])!==404){r.show(a.getI18nText("GetConsolidationVersionServiceCallError"))}}})},_createJournalEntriesFilterData:function(e){let t=e.getSource().getBindingContext();if(!t.getProperty("G+
LAccount")){return}let i=this.getModel("viewConfigDataModel").getData(),o=this.getView().byId("idFiscalYearFilter"),r=o.getDateValue().getFullYear(),a=parseInt(this.getView().byId("idPeriodFromInput").getValue(),[10]),s=parseInt(this.getView().byId("idPe+
riodToInput").getValue(),[10]),l=this.getView().byId("idConsUnit"),d=this.getView().byId("idCurrency"),g=this.getView().byId("idIntentionComboBox").getSelectedItem().getBindingContext("intentionVHModel").getObject(),u=n.convertStringToInt(g.PeriodTo)===0+
?"":n.convertStringToInt(g.TaxIntention),c=t.getProperty("GLAccount").padStart(10,"0"),h=[],f=false;let I=[],C=i.globalParameters.ConsolidationGroup,y=this.getView().byId("idTRFMainRepSegmentedBtn").getSelectedKey();if(y==="RGAAP"){I=[i.reconData.g2s,i.r+
econData.s2t]}else{I=[i.reconData.s2t]}let T=e.getSource().getCustomData();for(let e of T){let t=e.getValue();let n=e.getKey();if(n==="mappedAdjReason"){for(let e=0;e<i.adjustmentReason.length;e++){if(i.adjustmentReason[e].AdjustmentReason===t){h.push(i.+
adjustmentReason[e].TransType)}}continue}if(n==="mappedIsOpeningBalanceEntry"){f=true}}let m=e.getSource().getBindingInfo("text").parts,p=m[m.map(e=>e.path.indexOf("MainCurrency")!==0).indexOf(true)].path;let b=this.serviceDataProperty.property;b=b[b.map+
(e=>e.name).indexOf(p)];let S=b.extensions;S=S[S.map(e=>e.name).indexOf("label")];return{ConsolidationChartOfAccounts:i.globalParameters.ConsolidationChartofAccounts,FiscalYear:r,PeriodFrom:a,PeriodTo:s,ConsolidatioUnit:l.getSelectedKey(),ConsolidationLe+
dger:I,FinancialTransactionType:h,Value:t.getProperty(p),Currency:t.getProperty("MainCurrency"),GLAccount:c,ConsolidationVersion:"",SelectedIntention:u,ConsolidationGroup:"",PeriodMode:"PER",RefConsolidationDocumentType:"W",selectedCurrency:d.getSelected+
Key(),SectionName:S.value,GLAccountDesc:t.getProperty("GLAccountMdmText"),bIsOpeningBalanceEntry:f,ReportingType:y,Congr:C}},_fetchValidTaxRates:function(e){e=e?e:{};let t=this,n=this.getView(),o=n.byId("idConsUnit").getSelectedKey(),s=n.byId("idIntentio+
nComboBox").getSelectedItem(),l=n.byId("idFiscalYearFilter").getDateValue(),d=this.getModel();if(!s){return}let g=e.ConsolidationUnit?e.ConsolidationUnit:o,u=e.PeriodTo?e.PeriodTo:s.getBindingContext("intentionVHModel").getObject().PeriodTo,c=e.FiscalYea+
r?e.FiscalYear:l.getFullYear();if(!g||!u||!c){return}let h="/xEY1xSAV_C_Fetch_Tax_Rates(p_toperiod='"+u+"',p_ryear='"+c+"')/Set";d.read(h,{method:"GET",filters:[new i("ConsolidationUnit","EQ",g)],success:function(e){if(e.results.length<1){a.warning(t.get+
I18nText("warningTaxRatesNotMaintained"))}},error:function(e){r.show(t.getI18nText("warningFetchingTaxRates"))}})},onBeforeRebindTable:function(e){let t=this.getView(),n=t.getModel("viewConfigDataModel").getData();if(!n.globalParameters||!n.globalParamet+
ers.ConsolidationChartofAccounts||!n.globalParameters.ConsolidationGroup){a.error(this.getI18nText("errorMaintainGlobalParameter"));return}let r=t.byId("idConsUnit"),s=r.getSelectedKey(),l=t.byId("idCurrency"),d=l.getSelectedKey(),g=t.byId("idFiscalYearF+
ilter"),u=g.getDateValue().getFullYear(),c=t.byId("idPeriodToInput"),h=parseInt(c.getValue(),[10]),f,I,C;if(t.byId("idIntentionComboBox").getEnabled()===false){a.error(this.getI18nText("IntentionNotYetOpen")+u);this.oGlobalSmartTable.setTableBindingPath(+
"");return}let y=t.byId("idIntentionComboBox").getSelectedItem().getBindingContext("intentionVHModel"),T=y.getObject(),m=parseInt(T.CurrOpenPeriod,[10]);if(T.status===this.getI18nText("YetToOpen")){this.getBusyDialog().close();a.error(T.IntentDescription+
+" "+this.getI18nText("ThisIntentionNotYetOpen")+T.Gjahr);this.oGlobalSmartTable.setTableBindingPath("");return}if(h>m){this.getBusyDialog().close();a.error(this.getModel("i18n").getResourceBundle().getText("errorPeriodnotopen",[h,m]));this.oGlobalSmartT+
able.setTableBindingPath("");return}let p=parseInt(T.TaxIntention,[10]),b=p>12?p:"",S=this.getView().byId("idTRFMainRepSegmentedBtn").getSelectedKey();f=new i({filters:[new i("ConsolidationUnit",o.EQ,s),new i("ChartOfAccounts",o.EQ,"CANA"),new i("Consoli+
dationChartofAccounts",o.EQ,n.globalParameters.ConsolidationChartofAccounts),new i("MainCurrency",o.EQ,d),new i("ReportingType",o.EQ,S)],and:true});C=f;if(e.getParameter("bindingParams").filters.length>0){I=new i({filters:e.getParameter("bindingParams").+
filters});C=new i({filters:[f,I],and:true})}let V="/xEY1xSAV_C_TempRollForward(p_toperiod='"+h+"',p_ryear='"+u+"',p_taxintention='"+b+"',p_rbunit='"+s+"')/Results";this.oGlobalSmartTable.setTableBindingPath(V);let P=e.getParameter("bindingParams");P.filt+
ers=[C]},onBeforeVariantSaveFilterBar:function(e){let t=this.getView(),n=t.byId("idTRFMainRepSmartFilterBar"),i=t.byId("idConsUnit"),o=t.byId("idFiscalYearFilter"),r=t.byId("idIntentionComboBox"),a=t.byId("idCurrency"),s=t.byId("idPeriodToInput");n.setFi+
lterData({_CUSTOM:{ConsolidationUnit:i.getSelectedKey(),FiscalYear:o.getValue(),Intention:r.getSelectedKey(),CurrType:a.getSelectedKey(),PeriodTo:s.getValue(),VariantID:n.getCurrentVariantId()}})},onAfterVariantLoadFilterBar:function(e){var t=this.getVie+
w();var i=t.byId("idTRFMainRepSmartFilterBar");var o=t.byId("idConsUnit");var r=t.byId("idFiscalYearFilter");let a=t.byId("idIntentionComboBox");var s=t.byId("idCurrency");let l=this.getView().byId("idPeriodToInput");var d=i.getFilterData()["_CUSTOM"];o.+
setSelectedKey(d.ConsolidationUnit);r.setValue(d.FiscalYear);a.setSelectedKey(d.Intention);s.setSelectedKey(d.CurrType);l.setValue(n.convertStringToInt(d.PeriodTo));if(d.ConsolidationUnit){this.fetchReconLedgerData()}if(d.CurrType){s.setVisible(true);thi+
s._fetchCurrencyData(true)}if(d.ConsolidationUnit&&d.FiscalYear&&d.Intention){this._fetchValidTaxRates({ConsolidationUnit:d.ConsolidationUnit,PeriodTo:d.PeriodTo,FiscalYear:d.FiscalYear})}let g=[d.ConsolidationUnit,d.FiscalYear];this._fetchIntentionStatu+
s(g)},onSearchButtonPressed:function(e){let t=this.getModel().getServiceMetadata().dataServices.schema[0].entityType;this.serviceDataProperty=t.find(e=>e.name==="xEY1xSAV_C_TempRollForwardResult")},onSearch:function(e){if(e.getParameters().refreshButtonP+
ressed){this.onRefresh()}else{var t=[];var n=e.getParameter("query");if(n&&n.length>0){t=[new i("GLAccount",o.Contains,n)]}this._applySearch(t)}},onDataReceivedSmartTable:function(e){this.getBusyDialog().open();this.oGlobalSmartTable.getTable().setVisibl+
eRowCount(10);var t=window.setInterval(function(){this.onAdjustTableCol();window.clearInterval(t)}.bind(this),1e3)},onAdjustTableCol:function(){let e=this.oGlobalSmartTable;var t=e.getTable();var n=t.getColumns();for(var i=n.length-1;i>=0;i--){t.autoResi+
zeColumn(i)}this.getBusyDialog().close()},onChangeDatePickerFilter:function(e){let t=e.getSource(),n=this.getModel("viewConfigDataModel").getData(),i=n.globalParameters.ConsolidationUnit;if(e.getParameter("valid")){t.setValueState("None");let e=t.getDate+
Value().getFullYear(),n=[i,e];this._fetchIntentionStatus(n)}else{t.setValueState("Error")}if(e.getSource().getValue()){this._fetchValidTaxRates()}},onConsUnitChange:function(e){this._fetchCurrencyData(false);this.fetchReconLedgerData();if(e.getSource().g+
etValue()){this._fetchValidTaxRates()}},onChangeIntentionComboBox:function(e){let t=this.getView(),n=t.byId("idIntentionComboBox"),i=n.getSelectedItem();if(!i){n.setSelectedItem("");return}this._managePeriodFieldsEditability(true);if(e.getSource().getVal+
ue()){this._fetchValidTaxRates()}},fetchReconLedgerData:function(){let e=this.getModel();let n=e.createKey("/xEY1xSAV_C_Recon_Ledger",{bunit:this.byId("idConsUnit").getSelectedKey()});let i=this;e.read(n,{method:"GET",success:function(e,n){var o=i.getMod+
el("viewConfigDataModel");o.getData().reconData=e;o.refresh();i.getOwnerComponent().setModel(new t(e),"reconLedgerModel");i._fetchCnsldVersion()},error:function(e){if(parseInt(e.statusCode,[10])!==404){r.show(i.getI18nText("reconServiceCallError"))}}})},+
onLiveChangePeriodTo:function(){let e=this.getView().byId("idPeriodToInput");let t=parseInt(this.getView().byId("idPeriodFromInput").getValue(),[10]);let n=parseInt(e.getValue(),[10]);e.setValueState("None");if(n<t){e.setValueState("Error");e.setValueSta+
teText(this.getI18nText("periodToLessThanPeriodFromErrorMsg"));return}else if(n>"012"){e.setValueState("Error");e.setValueStateText(this.getI18nText("periodToGreaterThanLastPeriod"));return}else{this._managePerodicIntentionStatus(n)}},onPressColumnMenuOp+
enGLAccount:function(e){let t=e.getParameter("menu").getPopup();t.attachOpened(function(e){let t=e.getSource().getContent().getAggregation("items");let n=t.map(e=>e.getId().toString().indexOf("menu-freeze")!==-1).indexOf(true);t[n].setEnabled(false)})},o+
nPressTRFEntryDetails:function(e){var n=this._createJournalEntriesFilterData(e);if(!n){return}var i=new t(n);this.getOwnerComponent().setModel(i,"JournalEntryData");this.oRouter.navTo("JournalEntries")},onChangeButtonReportingType:function(e){let t=this.+
getView().byId("idTRFMainRepSmartFilterBar");if(t.validateMandatoryFields()){t.fireSearch()}}})});                                                                                                                                                             