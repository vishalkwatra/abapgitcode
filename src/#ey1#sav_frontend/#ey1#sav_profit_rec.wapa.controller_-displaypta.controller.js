sap.ui.define(["./BaseController","sap/ui/core/mvc/Controller","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/model/json/JSONModel","sap/m/MessageToast","sap/m/MessageBox","../model/formatter","sap/ui/core/routing/History","sap/ui/model/odat+
a/ODataUtils"],function(e,t,o,n,r,s,a,i,l,u){"use strict";const c="Local";const g="Group";return e.extend("ey.sap.fin.cs.profitrecon.controller.PostPTAEntries",{formatter:i,onInit:function(){this.oRouter=this.getOwnerComponent().getRouter();this.oRouter.+
getRoute("DisplayPTA").attachMatched(this._onRouteMatched,this)},_onRouteMatched:function(e){this.getBusyDialog().close();let t=this,o=e.getParameter("arguments").docId,n=this.getOwnerComponent().getModel("PTAEntryConfigData");if(n&&n.getData()){this._se+
tDynamicPageContent(o);if(o){let e=n.getData(),t={DocumentNumber:o,ConsolidationUnit:e.ConsolidationUnit,FiscalYear:e.FiscalYear};this._setPTAEntriesToDisplayMode(t)}}else{let e=this.getRouter();this.getBusyDialog().open();e.navTo("profitrecon",{},true)}+
},_setDynamicPageContent:function(e){let t=this.getView().byId("idPagePostPTAEntries");t.setContent(undefined);if(!this._oPTATableDisplayFragment){this._oPTATableDisplayFragment=sap.ui.xmlfragment("tablePTAEntriesCreate","ey.sap.fin.cs.profitrecon.fragme+
nt.PTAScreenTableDetails",this);this.getView().addDependent(this._oPTATableDisplayFragment)}if(!e){t.setContent(this._oPTATableCreateFragment)}else{t.setContent(this._oPTATableDisplayFragment)}},_structureHeaderData:function(){let e=new Date,t=this.postP+
TAEntriesConfigModel.getData().ConsolidationUnit,o=this.postPTAEntriesConfigModel.getData().FiscalYear,n=this.postPTAEntriesConfigModel.getData().currLocalGroupVHData;let s=n.results.find(e=>e.ConsolidationUnit===t&&e.CurrencyType===c);let a=n.results.fi+
nd(e=>e.ConsolidationUnit===t&&e.CurrencyType===g);let i={DocumentNumber:"",ConsolidationUnit:s.ConsolidationUnit,ConsolidationUnitDescription:s.ConsolidationUnitDescription,LocalCurrency:s.Currency,GroupCurrency:a.Currency,FiscalPeriod:"",PostingDate:e.+
getFullYear()===o?e:"",PostingDateDisplay:"",FiscalYear:o.toString()};this.getView().byId("idPostingDatePickerPTAEntries").setValueState("None");this.setModel(new r(i),"postPTAHeaderModel");this._fetchTableData(i);if(i.PostingDate){this._callDeterminePer+
iod()}},_fetchTableData:function(e){let t=this.getModel(),o=this,n=this._generateTableServiceCallFilters(e),r=this.postPTAEntriesConfigModel.getData();this.getBusyDialog().open();t.read(r.sServicePath,{method:"GET",urlParameters:{$select:"GLAccount,GLAcc+
ountMdmText,FinancialStatementItem,ConsolidationRptgItemMdmText,TaxPTA,TaxClosingBalance"},filters:[n],sorters:[new sap.ui.model.Sorter("GLAccount")],success:function(e,t){o.getBusyDialog().close();o._setTableModelStructure(e)},error:function(e){o.getBus+
yDialog().close();s.show(o.getResourceBundle().getText("serviceCallErrorPTAHeader"))}})},_generateTableServiceCallFilters:function(e){let t=this.postPTAEntriesConfigModel.getData(),r=t.postPTAEntriesList;let s=[];for(let e of r){s.push(new o("GLAccount",+
n.EQ,e))}let a=new o({filters:s});let i=new o({filters:[new o("ConsolidationUnit",n.EQ,e.ConsolidationUnit),new o("ChartOfAccounts",n.EQ,"CANA"),new o("ConsolidationChartofAccounts",n.EQ,t.globalParameterData.globalParameters.ConsolidationChartofAccounts+
),new o("MainCurrency",n.EQ,e.LocalCurrency)],and:true});let l=new o({filters:[a,i],and:true});return l},_setTableModelStructure:function(e){let t=[];let o={AmountInLocalCurrency:"0.00",AmountInGroupCurrency:"0.00",Text:this.getResourceBundle().getText("+
commentsPTAEntriesText")};for(let n=0;n<e.results.length;n++){t.push(Object.assign({},e.results[n],o,{LineItem:(n+1).toString()}))}this.setModel(new r({results:t}),"postPTATableModel");this._oPTATableCreateFragment.getHeaderToolbar().getTitleControl().se+
tText(this.getResourceBundle().getText("selectedAccountsText",[this._oPTATableCreateFragment.getBinding("items").getLength()]))},_callDeterminePeriod:function(){let e=this.getModel("postPTAHeaderModel"),t=e.getData(),o=this.getOwnerComponent().getModel()+
,n=this,r="/DeterminePeriod";t.PostingDate.setMinutes(t.PostingDate.getMinutes()-t.PostingDate.getTimezoneOffset());o.callFunction(r,{method:"GET",urlParameters:{ConsolidationLedger:this.postPTAEntriesConfigModel.getData().globalParameterData.reconData.t+
ax,ConsolidationUnit:t.ConsolidationUnit,Date:t.PostingDate},success:function(t){n._iFetchedFiscalPeriod=t.Period;e.setProperty("/FiscalPeriod",t.Period)},error:function(t){e.setProperty("/FiscalPeriod","");a.error(JSON.parse(t.responseText).error.messag+
e.value)}})},_setPTAEntriesToDisplayMode:function(e){let t=this.getModel(),s=this;this.getBusyDialog().open();t.read("/xEY1xSAV_C_Rec_PTA",{method:"GET",filters:[new o("DocumentNumber",n.EQ,e.DocumentNumber),new o("ConsolidationUnit",n.EQ,e.Consolidation+
Unit),new o("FiscalYear",n.EQ,e.FiscalYear)],sorters:[new sap.ui.model.Sorter("GLAccount")],success:function(e,t){s.getBusyDialog().close();let o=e.results[0];let n={DocumentNumber:o.DocumentNumber,ConsolidationUnit:o.ConsolidationUnit,ConsolidationUnitD+
escription:o.ConsolidationUnitDescription,LocalCurrency:o.LocalCurrency,GroupCurrency:o.GroupCurrency,FiscalPeriod:i.convertStringToInt(o.FiscalPeriod),PostingDate:o.PostingDate,PostingDateDisplay:o.PostingDateDisplay,FiscalYear:o.FiscalYear};s.setModel(+
new r(n),"postPTAHeaderModel");s.getModel("postPTAHeaderModel").refresh(true);s.setModel(new r(e),"postPTATableDisplayModel");s._oPTATableDisplayFragment.getHeaderToolbar().getTitleControl().setText(s.getResourceBundle().getText("accountsText",[s._oPTATa+
bleDisplayFragment.getBinding("items").getLength()]))},error:function(e){s.getBusyDialog().close()}})},_onPressShellNavBack:function(){let e=this.getView().getModel("postPTAHeaderModel").getData().DocumentNumber;if(e===""){this._unsavedChangesWarning()}e+
lse{if(l.getInstance().getPreviousHash()!==undefined){window.history.go(-1)}else{this.oRouter.navTo("Reconciliation",{},true)}}},_unsavedChangesWarning:function(){let e=this.getResourceBundle().getText("btnTextLeavePage");a.warning(this.getResourceBundle+
().getText("errorMsgLeavePTAEntriesScreen"),{actions:[e,a.Action.CANCEL],emphasizedAction:e,onClose:function(t){if(t===e){if(l.getInstance().getPreviousHash()!==undefined){window.history.go(-1)}else{this.oRouter.navTo("Reconciliation",{},true)}}}})},_cal+
lMassCurrencyConversion:function(){let e=this.getOwnerComponent().getModel(),t=this.getModel("postPTATableModel"),o=t.getData().results,n=this.getModel("postPTAHeaderModel").getData(),r=encodeURIComponent(u.formatValue(n.PostingDate,"Edm.DateTime")),s=th+
is;e.setUseBatch(true);e.setChangeGroups({"/Z_RECON_GAAP_STAT_TAX_SRV":{groupId:"groupIdConvertCurrency",changeSetId:"ID",single:false}});e.setDeferredGroups(["groupIdConvertCurrency"]);let a=false;for(let t of o){let o=u.formatValue(parseFloat(t.AmountI+
nLocalCurrency),"Edm.Decimal");if(parseFloat(t.AmountInLocalCurrency)!==0){a=true;e.read("/ConvertCurrencySet(FromAmount="+o+",FromCurrency='"+n.LocalCurrency+"',ExchangeRateDate="+r+",ToCurrency='"+n.GroupCurrency+"')",{groupId:"groupIdConvertCurrency"}+
)}}if(!a){return}this.getBusyDialog().open();e.submitChanges({groupId:"groupIdConvertCurrency",success:function(e){s.getBusyDialog().close();let r=e.__batchResponses;if(!(r.length>0)){return}let a=(e,t)=>{let o=e.find(e=>parseFloat(e.data.FromAmount)===M+
ath.round(parseFloat(t.AmountInLocalCurrency))&&e.data.FromCurrency===n.LocalCurrency);if(o){return o.data.ToAmount}return 0};for(let e of o){if(parseFloat(e.AmountInLocalCurrency)!==0){e.AmountInGroupCurrency=a(r,e)}}t.refresh(true)},error:function(e){s+
.getBusyDialog().close()}})},onPressTestButton:function(){},onChangePostPTATableLocalCurrency:function(e){let t=e.getSource(),o=t.getBindingContext("postPTATableModel").getObject();if(t.getValue()===""||parseFloat(t.getValue(),[10])===0){o.AmountInGroupC+
urrency=parseFloat(0).toFixed(2);o.AmountInLocalCurrency=parseFloat(0).toFixed(2);return}let n=this.getOwnerComponent().getModel(),r=this.getModel("postPTAHeaderModel").getData(),s=this.getModel("postPTATableModel"),i=this;if(!(new Date(r.PostingDate)ins+
tanceof Date)||!r.PostingDate){let e=this.getView().byId("idPostingDatePickerPTAEntries");e.setValueState("Error");e.setValueStateText(this.getResourceBundle().getText("errorMsgPostingDateInvalid"));o.AmountInLocalCurrency=parseFloat(0).toFixed(2);return+
}this.getBusyDialog().open();n.callFunction("/ConvertCurrency",{method:"GET",urlParameters:{Amount:o.AmountInLocalCurrency,FromCurrency:r.LocalCurrency,ToCurrency:r.GroupCurrency,ExchangeRateDate:new Date(r.PostingDate)},success:function(e){t.setValue(pa+
rseFloat(t.getValue()).toFixed(2));o.AmountInGroupCurrency=parseFloat(e.ToAmount).toFixed(2);s.refresh(true);i.getBusyDialog().close()},error:function(e){i.getBusyDialog().close();a.error(i.getResourceBundle().getText("errorMsgReadingCurrecyConversion"))+
}})},onSearchPostPTAEntriesTable:function(e){let t=e.getSource().getValue(),r=[],s=this._oPTATableCreateFragment||e.getSource().getParent().getParent(),a=s.getBinding("items");if(t&&t.length>0){r=[new o("GLAccount",n.Contains,t),new o("GLAccountMdmText",+
n.Contains,t)];a.filter(new o(r,false))}else{a.filter([])}s.getHeaderToolbar().getTitleControl().setText(this.getResourceBundle().getText("selectedAccountsText",[a.getLength()]))},onSearchPostPTAEntriesTableDisplay:function(e){let t=e.getSource().getValu+
e(),r=[],s=this._oPTATableDisplayFragment||e.getSource().getParent().getParent(),a=s.getBinding("items");if(t&&t.length>0){r=[new o("GLAccount",n.Contains,t),new o("GLAccountMdmText",n.Contains,t)];a.filter(new o(r,false))}else{a.filter([])}s.getHeaderTo+
olbar().getTitleControl().setText(this.getResourceBundle().getText("selectedAccountsText",[a.getLength()]))},onChangePostingDatePTA:function(e){let t=e.getSource(),o=t.getDateValue(),n=sap.ui.core.format.DateFormat.getDateTimeInstance({pattern:"dd.MM.yyy+
y"}),r=this.getModel("postPTAHeaderModel");if(n.format(t.getDateValue())===n.format(r.getProperty("/PostingDate"))){return}if(o&&e.getParameter("valid")){t.setValueState("None");r.setProperty("/PostingDate",o);this._callDeterminePeriod();this._callMassCu+
rrencyConversion()}else{r.setProperty("/PostingDate","");r.setProperty("/FiscalPeriod","");t.setValueState("Error");t.setValueStateText(this.getResourceBundle().getText("errorMsgPostingDateInvalid"));a.error(this.getResourceBundle().getText("errorMsgPost+
ingDateInvalid"))}},onPressPostBtnPostPTAEntries:function(e){let t=this.getModel("postPTAHeaderModel").getData();if(!t.PostingDate||!t.FiscalPeriod){a.error(this.getResourceBundle().getText("errorMsgPostingDateInvalid"));return}if(t.FiscalPeriod>17){a.er+
ror(this.getResourceBundle().getText("errorMsgFiscalPeriodInvalid"));return}if(t.PostingDate.getFullYear().toString()!==t.FiscalYear){a.error(this.getResourceBundle().getText("errorMsgPostingDateMismatch",[t.FiscalYear]));return}let o=this.getModel("post+
PTATableModel").getData().results;if(!o.find(e=>parseInt(e.AmountInLocalCurrency,10)!==0&&e.AmountInLocalCurrency!=="")){a.error(this.getResourceBundle().getText("errorMsgEnterLocalCurrencyAmout"));return}let n=this;if(o.find(e=>parseInt(e.AmountInLocalC+
urrency,10)===0||e.AmountInLocalCurrency==="")){a.warning(this.getResourceBundle().getText("warningMsgPTALCAmountNotEnteredForSomeFields"),{actions:[a.Action.OK,a.Action.CANCEL],emphasizedAction:a.Action.OK,onClose:function(e){if(e===a.Action.OK){n.postB+
atchChangesEntries()}else{return}}})}else{this.postBatchChangesEntries()}},postBatchChangesEntries:function(){let e=this.getOwnerComponent().getModel(),t=sap.ui.core.format.DateFormat.getDateTimeInstance({pattern:"yyyy-MM-ddT00:00:00"}),o=this,n=this.get+
Model("postPTATableModel").getData().results,r=this.getModel("postPTAHeaderModel").getData();e.setUseBatch(true);e.setChangeGroups({"/Z_RECON_GAAP_STAT_TAX_SRV":{groupId:"groupIdPostPTA",changeSetId:"ID",single:false}});e.setDeferredGroups(["groupIdPostP+
TA"]);let i=0;for(var l=0;l<n.length;l++){let o=Object.assign({},n[l],r);if(!isNaN(o.AmountInLocalCurrency)&&parseInt(o.AmountInLocalCurrency,[10])!==0&&o.AmountInLocalCurrency!==""){let n=["ConsolidationRptgItemMdmText","ConsolidationUnitDescription","G+
LAccountMdmText","TaxPTA","TaxClosingBalance","PostingDateDisplay","__metadata","LineItem"];n.forEach(e=>delete o[e]);i++;o.LineItem=i.toString();o.PostingDate=t.format(new Date(r.PostingDate));e.create("/xEY1xSAV_C_Rec_PTA",o,{groupId:"groupIdPostPTA"})+
}}this.getBusyDialog().open();e.submitChanges({groupId:"groupIdPostPTA",success:function(e,t){o.getBusyDialog().close();let n=e.__batchResponses[0].__changeResponses;if(!n||n.length<=0){return}let r=JSON.parse(n.find(e=>e.headers["sap-message"]).headers[+
"sap-message"]);let i=n[0].data;let l={DocumentNumber:i.DocumentNumber,ConsolidationUnit:i.ConsolidationUnit,FiscalYear:i.FiscalYear};o.postPTAEntriesConfigModel.setProperty("/DocumentNumber",i.DocumentNumber);if(r&&r.severity.toUpperCase()==="SUCCESS"){+
s.show(r.message);o._setDynamicPageContent(i.DocumentNumber);o._setPTAEntriesToDisplayMode(l)}else if(r&&r.message){a.error(r.message)}},error:function(e){o.getBusyDialog().close()}})},onPressCancelBtnPostPTAEntries:function(e){this._unsavedChangesWarnin+
g()},onChangePostingPeriodPTAEntries:function(e){let t=e.getSource(),o=t.getValue();if(!o||parseInt(o,[10])<12){t.setValue(this._iFetchedFiscalPeriod)}}})});                                                                                                  