sap.ui.define(["./BaseController","sap/ui/core/mvc/Controller","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/model/json/JSONModel","sap/m/MessageToast","sap/m/MessageBox","../model/formatter","sap/ui/core/routing/History","sap/ui/model/odat+
a/ODataUtils"],function(e,t,o,n,r,s,a,i,l,u){"use strict";const c="Local";const g="Group";return e.extend("ey.sap.fin.cs.recgaapstattax.controller.PostPTAEntries",{formatter:i,onInit:function(){this.oRouter=this.getOwnerComponent().getRouter();this.oRout+
er.getRoute("PostPTAEntries").attachMatched(this._onRouteMatched,this)},_onRouteMatched:function(e){this.getBusyDialog().close();let t=this,o=e.getParameter("arguments").docId,n=this.getOwnerComponent().getModel("PTAEntryConfigData");this.postPTAEntriesC+
onfigModel=this.getOwnerComponent().getModel("postPTAEntriesConfigModel");if(this.postPTAEntriesConfigModel&&this.postPTAEntriesConfigModel.getData()){this._setDynamicPageContent(o);this.getOwnerComponent().getService("ShellUIService").then(function(e){e+
.setBackNavigation(t._onPressShellNavBack.bind(t))});if(!o){this._structureHeaderData()}else if(n&&n.getData()){let e=n.getData(),t={DocumentNumber:o,ConsolidationUnit:e.ConsolidationUnit,FiscalYear:e.FiscalYear};this._setPTAEntriesToDisplayMode(t)}}else+
{let e=this.getRouter();this.getBusyDialog().open();e.navTo("Reconciliation",{},true)}},_setDynamicPageContent:function(e){let t=this.getView().byId("idPagePostPTAEntries");t.setContent(undefined);if(!this._oPTATableCreateFragment){this._oPTATableCreateF+
ragment=sap.ui.xmlfragment("tablePTAEntriesCreate","ey.sap.fin.cs.recgaapstattax.fragment.PTAScreenTableCreate",this);this.getView().addDependent(this._oPTATableCreateFragment)}if(!this._oPTATableDisplayFragment){this._oPTATableDisplayFragment=sap.ui.xml+
fragment("tablePTAEntriesCreate","ey.sap.fin.cs.recgaapstattax.fragment.PTAScreenTableDetails",this);this.getView().addDependent(this._oPTATableDisplayFragment)}if(!e){t.setContent(this._oPTATableCreateFragment)}else{t.setContent(this._oPTATableDisplayFr+
agment)}},_structureHeaderData:function(){let e=new Date,t=this.postPTAEntriesConfigModel.getData().ConsolidationUnit,o=this.postPTAEntriesConfigModel.getData().FiscalYear,n=this.postPTAEntriesConfigModel.getData().currLocalGroupVHData,s=this.postPTAEntr+
iesConfigModel.getData().TaxIntention,a=this.postPTAEntriesConfigModel.getData().TaxIntentionDesc,i=this.postPTAEntriesConfigModel.getData().postingDate;let l=n.results.find(e=>e.ConsolidationUnit===t&&e.CurrencyType===c);let u=n.results.find(e=>e.Consol+
idationUnit===t&&e.CurrencyType===g);let d=i.POSTINGDATE;var T=d.substring(0,4);var C=d.substring(4,6);var h=d.substring(6,8);var p=new Date(T,C-1,h);let P={DocumentNumber:"",ConsolidationUnit:l.ConsolidationUnit,ConsolidationUnitDescription:l.Consolidat+
ionUnitDescription,LocalCurrency:l.Currency,GroupCurrency:u.Currency,FiscalPeriod:"",TaxIntention:s,IntentDescription:a,PostingDate:e.getFullYear()===o?e:p,PostingDateDisplay:p,FiscalYear:o.toString()};this.setModel(new r(P),"postPTAHeaderModel");this._f+
etchTableData(P);if(P.PostingDate){this._callDeterminePeriod()}},_fetchTableData:function(e){let t=this.getModel(),o=this,n=this._generateTableServiceCallFilters(e),r=this.postPTAEntriesConfigModel.getData();this.getBusyDialog().open();t.read(r.sServiceP+
ath,{method:"GET",urlParameters:{$select:"GLAccount,GLAccountMdmText,FinancialStatementItem,ConsolidationRptgItemMdmText,TaxPTA,TaxClosingBalance"},filters:[n],sorters:[new sap.ui.model.Sorter("GLAccount")],success:function(e,t){o.getBusyDialog().close()+
;o._setTableModelStructure(e)},error:function(e){o.getBusyDialog().close();s.show(o.getResourceBundle().getText("serviceCallErrorPTAHeader"))}})},_generateTableServiceCallFilters:function(e){let t=this.postPTAEntriesConfigModel.getData(),r=t.postPTAEntri+
esList;let s=[];for(let e of r){s.push(new o("GLAccount",n.EQ,e))}let a=new o({filters:s});let i=new o({filters:[new o("ConsolidationUnit",n.EQ,e.ConsolidationUnit),new o("ChartOfAccounts",n.EQ,"CANA"),new o("ConsolidationChartofAccounts",n.EQ,t.globalPa+
rameterData.globalParameters.ConsolidationChartofAccounts),new o("MainCurrency",n.EQ,e.LocalCurrency)],and:true});let l=new o({filters:[a,i],and:true});return l},_setTableModelStructure:function(e){let t=[];let o={AmountInLocalCurrency:"0.00",AmountInGro+
upCurrency:"0.00",Text:this.getResourceBundle().getText("commentsPTAEntriesText")};for(let n=0;n<e.results.length;n++){t.push(Object.assign({},e.results[n],o,{LineItem:(n+1).toString()}))}this.setModel(new r({results:t}),"postPTATableModel");this._oPTATa+
bleCreateFragment.getHeaderToolbar().getTitleControl().setText(this.getResourceBundle().getText("selectedAccountsText",[this._oPTATableCreateFragment.getBinding("items").getLength()]))},_callDeterminePeriod:function(){let e=this.getModel("postPTAHeaderMo+
del"),t=e.getData(),o=this.getOwnerComponent().getModel(),n=this,r="/DeterminePeriod";t.PostingDate.setMinutes(t.PostingDate.getMinutes()-t.PostingDate.getTimezoneOffset());o.callFunction(r,{method:"GET",urlParameters:{ConsolidationLedger:this.postPTAEnt+
riesConfigModel.getData().globalParameterData.reconData.tax,ConsolidationUnit:t.ConsolidationUnit,Date:t.PostingDate},success:function(t){n._iFetchedFiscalPeriod=t.Period;e.setProperty("/FiscalPeriod",t.Period)},error:function(t){e.setProperty("/FiscalPe+
riod","");a.error(JSON.parse(t.responseText).error.message.value)}})},_setPTAEntriesToDisplayMode:function(e){let t=this.getModel(),s=this;this.getBusyDialog().open();t.read("/xEY1xSAV_C_Rec_PTA",{method:"GET",filters:[new o("DocumentNumber",n.EQ,e.Docum+
entNumber),new o("ConsolidationUnit",n.EQ,e.ConsolidationUnit),new o("FiscalYear",n.EQ,e.FiscalYear)],sorters:[new sap.ui.model.Sorter("GLAccount")],success:function(e,t){s.getBusyDialog().close();let o=e.results[0];let n={DocumentNumber:o.DocumentNumber+
,ConsolidationUnit:o.ConsolidationUnit,ConsolidationUnitDescription:o.ConsolidationUnitDescription,LocalCurrency:o.LocalCurrency,GroupCurrency:o.GroupCurrency,FiscalPeriod:i.convertStringToInt(o.FiscalPeriod),TaxIntention:o.TaxIntention,IntentDescription+
:o.TaxIntentionText,PostingDate:o.PostingDate,PostingDateDisplay:o.PostingDateDisplay,FiscalYear:o.FiscalYear};s.setModel(new r(n),"postPTAHeaderModel");s.getModel("postPTAHeaderModel").refresh(true);s.setModel(new r(e),"postPTATableDisplayModel");s._oPT+
ATableDisplayFragment.getHeaderToolbar().getTitleControl().setText(s.getResourceBundle().getText("accountsText",[s._oPTATableDisplayFragment.getBinding("items").getLength()]))},error:function(e){s.getBusyDialog().close()}})},_onPressShellNavBack:function+
(){let e=this.getView().getModel("postPTAHeaderModel").getData().DocumentNumber;if(e===""){this._unsavedChangesWarning()}else{if(l.getInstance().getPreviousHash()!==undefined){window.history.go(-1)}else{this.oRouter.navTo("Reconciliation",{},true)}}},_un+
savedChangesWarning:function(){let e=this.getResourceBundle().getText("btnTextLeavePage");a.warning(this.getResourceBundle().getText("errorMsgLeavePTAEntriesScreen"),{actions:[e,a.Action.CANCEL],emphasizedAction:e,onClose:function(t){if(t===e){if(l.getIn+
stance().getPreviousHash()!==undefined){window.history.go(-1)}else{this.oRouter.navTo("Reconciliation",{},true)}}}})},_callMassCurrencyConversion:function(){let e=this.getOwnerComponent().getModel(),t=this.getModel("postPTATableModel"),o=t.getData().resu+
lts,n=this.getModel("postPTAHeaderModel").getData(),r=encodeURIComponent(u.formatValue(n.PostingDate,"Edm.DateTime")),s=this;e.setUseBatch(true);e.setChangeGroups({"/Z_RECON_GAAP_STAT_TAX_SRV":{groupId:"groupIdConvertCurrency",changeSetId:"ID",single:fal+
se}});e.setDeferredGroups(["groupIdConvertCurrency"]);let a=false;for(let t of o){let o=u.formatValue(parseFloat(t.AmountInLocalCurrency),"Edm.Decimal");if(parseFloat(t.AmountInLocalCurrency)!==0){a=true;e.read("/ConvertCurrencySet(FromAmount="+o+",FromC+
urrency='"+n.LocalCurrency+"',ExchangeRateDate="+r+",ToCurrency='"+n.GroupCurrency+"')",{groupId:"groupIdConvertCurrency"})}}if(!a){return}this.getBusyDialog().open();e.submitChanges({groupId:"groupIdConvertCurrency",success:function(e){s.getBusyDialog()+
.close();let r=e.__batchResponses;if(!(r.length>0)){return}let a=(e,t)=>{let o=e.find(e=>parseFloat(e.data.FromAmount)===Math.round(parseFloat(t.AmountInLocalCurrency))&&e.data.FromCurrency===n.LocalCurrency);if(o){return o.data.ToAmount}return 0};for(le+
t e of o){if(parseFloat(e.AmountInLocalCurrency)!==0){e.AmountInGroupCurrency=a(r,e)}}t.refresh(true)},error:function(e){s.getBusyDialog().close()}})},onPressTestButton:function(){},onChangePostPTATableLocalCurrency:function(e){let t=e.getSource(),o=t.ge+
tBindingContext("postPTATableModel").getObject();if(t.getValue()===""||parseFloat(t.getValue(),[10])===0){o.AmountInGroupCurrency=parseFloat(0).toFixed(2);o.AmountInLocalCurrency=parseFloat(0).toFixed(2);return}let n=this.getOwnerComponent().getModel(),r+
=this.getModel("postPTAHeaderModel").getData(),s=this.getModel("postPTATableModel"),i=this;this.getBusyDialog().open();n.callFunction("/ConvertCurrency",{method:"GET",urlParameters:{Amount:o.AmountInLocalCurrency,FromCurrency:r.LocalCurrency,ToCurrency:r+
.GroupCurrency,ExchangeRateDate:new Date(r.PostingDate)},success:function(e){t.setValue(parseFloat(t.getValue()).toFixed(2));o.AmountInGroupCurrency=parseFloat(e.ToAmount).toFixed(2);s.refresh(true);i.getBusyDialog().close()},error:function(e){i.getBusyD+
ialog().close();a.error(i.getResourceBundle().getText("errorMsgReadingCurrecyConversion"))}})},onSearchPostPTAEntriesTable:function(e){let t=e.getSource().getValue(),r=[],s=this._oPTATableCreateFragment||e.getSource().getParent().getParent(),a=s.getBindi+
ng("items");if(t&&t.length>0){r=[new o("GLAccount",n.Contains,t),new o("GLAccountMdmText",n.Contains,t)];a.filter(new o(r,false))}else{a.filter([])}s.getHeaderToolbar().getTitleControl().setText(this.getResourceBundle().getText("selectedAccountsText",[a.+
getLength()]))},onSearchPostPTAEntriesTableDisplay:function(e){let t=e.getSource().getValue(),r=[],s=this._oPTATableDisplayFragment||e.getSource().getParent().getParent(),a=s.getBinding("items");if(t&&t.length>0){r=[new o("GLAccount",n.Contains,t),new o(+
"GLAccountMdmText",n.Contains,t)];a.filter(new o(r,false))}else{a.filter([])}s.getHeaderToolbar().getTitleControl().setText(this.getResourceBundle().getText("selectedAccountsText",[a.getLength()]))},onChangePostingDatePTA:function(e){let t=e.getSource(),+
o=t.getDateValue(),n=sap.ui.core.format.DateFormat.getDateTimeInstance({pattern:"dd.MM.yyyy"}),r=this.getModel("postPTAHeaderModel");if(n.format(t.getDateValue())===n.format(r.getProperty("/PostingDate"))){return}if(o&&e.getParameter("valid")){t.setValue+
State("None");r.setProperty("/PostingDate",o);this._callDeterminePeriod();this._callMassCurrencyConversion()}else{r.setProperty("/PostingDate","");r.setProperty("/FiscalPeriod","");t.setValueState("Error");t.setValueStateText(this.getResourceBundle().get+
Text("errorMsgPostingDateInvalid"));a.error(this.getResourceBundle().getText("errorMsgPostingDateInvalid"))}},onPressPostBtnPostPTAEntries:function(e){let t=this.getModel("postPTAHeaderModel").getData();if(!t.PostingDate||!t.FiscalPeriod){a.error(this.ge+
tResourceBundle().getText("errorMsgPostingDateInvalid"));return}if(t.FiscalPeriod>17){a.error(this.getResourceBundle().getText("errorMsgFiscalPeriodInvalid"));return}if(t.PostingDate.getFullYear().toString()!==t.FiscalYear){a.error(this.getResourceBundle+
().getText("errorMsgPostingDateMismatch",[t.FiscalYear]));return}let o=this.getModel("postPTATableModel").getData().results;if(!o.find(e=>parseInt(e.AmountInLocalCurrency,10)!==0&&e.AmountInLocalCurrency!=="")){a.error(this.getResourceBundle().getText("e+
rrorMsgEnterLocalCurrencyAmout"));return}let n=this;if(o.find(e=>parseInt(e.AmountInLocalCurrency,10)===0||e.AmountInLocalCurrency==="")){a.warning(this.getResourceBundle().getText("warningMsgPTALCAmountNotEnteredForSomeFields"),{actions:[a.Action.OK,a.A+
ction.CANCEL],emphasizedAction:a.Action.OK,onClose:function(e){if(e===a.Action.OK){n.postBatchChangesEntries()}else{return}}})}else{this.postBatchChangesEntries()}},postBatchChangesEntries:function(){let e=this.getOwnerComponent().getModel(),t=sap.ui.cor+
e.format.DateFormat.getDateTimeInstance({pattern:"yyyy-MM-ddT00:00:00"}),o=this,n=this.getModel("postPTATableModel").getData().results,r=this.getModel("postPTAHeaderModel").getData();e.setUseBatch(true);e.setChangeGroups({"/Z_RECON_GAAP_STAT_TAX_SRV":{gr+
oupId:"groupIdPostPTA",changeSetId:"ID",single:false}});e.setDeferredGroups(["groupIdPostPTA"]);let i=0;for(var l=0;l<n.length;l++){let o=Object.assign({},n[l],r);if(!isNaN(o.AmountInLocalCurrency)&&parseInt(o.AmountInLocalCurrency,[10])!==0&&o.AmountInL+
ocalCurrency!==""){let n=["ConsolidationRptgItemMdmText","ConsolidationUnitDescription","GLAccountMdmText","TaxPTA","TaxClosingBalance","PostingDateDisplay","__metadata","LineItem","IntentDescription"];n.forEach(e=>delete o[e]);i++;o.LineItem=i.toString(+
);o.PostingDate=t.format(new Date(r.PostingDate));e.create("/xEY1xSAV_C_Rec_PTA",o,{groupId:"groupIdPostPTA"})}}this.getBusyDialog().open();e.submitChanges({groupId:"groupIdPostPTA",success:function(e,t){o.getBusyDialog().close();let n=e.__batchResponses+
[0].__changeResponses;if(!n||n.length<=0){return}let r=JSON.parse(n.find(e=>e.headers["sap-message"]).headers["sap-message"]);let i=n[0].data;let l={DocumentNumber:i.DocumentNumber,ConsolidationUnit:i.ConsolidationUnit,FiscalYear:i.FiscalYear};o.postPTAE+
ntriesConfigModel.setProperty("/DocumentNumber",i.DocumentNumber);if(r&&r.severity.toUpperCase()==="SUCCESS"){s.show(r.message);o._setDynamicPageContent(i.DocumentNumber);o._setPTAEntriesToDisplayMode(l)}else if(r&&r.message){a.error(r.message)}},error:f+
unction(e){o.getBusyDialog().close()}})},onPressCancelBtnPostPTAEntries:function(e){this._unsavedChangesWarning()},onChangePostingPeriodPTAEntries:function(e){let t=e.getSource(),o=t.getValue();if(!o||parseInt(o,[10])<12){t.setValue(this._iFetchedFiscalP+
eriod)}}})});                                                                                                                                                                                                                                                  