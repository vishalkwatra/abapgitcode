sap.ui.define([                                                                                                                                                                                                                                                
	"sap/ui/model/Filter",                                                                                                                                                                                                                                        
	"sap/ui/core/Fragment",                                                                                                                                                                                                                                       
	"sap/ui/core/mvc/Controller",                                                                                                                                                                                                                                 
	"sap/ui/model/FilterOperator",                                                                                                                                                                                                                                
	"sap/ui/model/json/JSONModel",                                                                                                                                                                                                                                
	"sap/m/MessageToast",                                                                                                                                                                                                                                         
	"sap/m/MessageBox",                                                                                                                                                                                                                                           
	"sap/fin/gl/lib/posting/util/Constants",                                                                                                                                                                                                                      
	"sap/fin/gl/lib/posting/controller/AbstractPostingController"                                                                                                                                                                                                 
], function (F, a, C, b, JSONModel, MessageToast, MessageBox, Constants, A) {                                                                                                                                                                                  
	"use strict";                                                                                                                                                                                                                                                 
	var P = sap.ui.controller("fin.gl.documentpost.FIN_GLDOCPOSTExtension.controller.PostingCustom", {                                                                                                                                                            
		onInit: function () {                                                                                                                                                                                                                                        
			var e = {                                                                                                                                                                                                                                                   
				"FinsPostingGLHeader": {                                                                                                                                                                                                                                   
					containerId: ""                                                                                                                                                                                                                                           
				},                                                                                                                                                                                                                                                         
				"FinsPostingGLItem": {                                                                                                                                                                                                                                     
					containerId: ""                                                                                                                                                                                                                                           
				},                                                                                                                                                                                                                                                         
				"FinsPostingTax": {                                                                                                                                                                                                                                        
					containerId: ""                                                                                                                                                                                                                                           
				},                                                                                                                                                                                                                                                         
				"ScreenVariantButtonSubHeader": {                                                                                                                                                                                                                          
					containerId: "fin.gl.documentpost.btnScreenVariantSelect"                                                                                                                                                                                                 
				},                                                                                                                                                                                                                                                         
				"TotalBalanceSubHeader": {                                                                                                                                                                                                                                 
					containerId: "fin.gl.documentpost.totalBalanceSubHeader"                                                                                                                                                                                                  
				}                                                                                                                                                                                                                                                          
			};                                                                                                                                                                                                                                                          
			this.abstractOnInit(e);                                                                                                                                                                                                                                     
			this.getView().getModel("share").setProperty("/shareOnJamTitle", this.getResourceBundle().getText("shareOnJamTitle"));                                                                                                                                      
                                                                                                                                                                                                                                                               
			//custom extended code.........................//////////////////////////////////////////////                                                                                                                                                               
			this.oRouter = this.getOwnerComponent().getRouter();                                                                                                                                                                                                        
			this.oRouter.getRoute("fullscreen").attachMatched(this._onRouteMatched, this);                                                                                                                                                                              
		},                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
		_onRouteMatched: function (oEvent) {                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                               
			let sServiceURLLedgerCode = "/ZZ1_LedgerGroupSet",                                                                                                                                                                                                          
				sServiceURLSpecialPer = "/ZZ1_TaxIntentionSet",                                                                                                                                                                                                            
				aItems = this.byId("sap.fin.gl.lib.posting.items").getItems();                                                                                                                                                                                             
                                                                                                                                                                                                                                                               
			//getting value help data for ledger grp and special period at line item level                                                                                                                                                                              
			this._getValidationData(sServiceURLLedgerCode, "ledgerGrpVHModel");                                                                                                                                                                                         
                                                                                                                                                                                                                                                               
		},                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
		//getting value help data for ledger grp and special period at line item level                                                                                                                                                                               
		_getValidationData: function (sServiceURL, sModel) {                                                                                                                                                                                                         
			let oServiceCallModel = this.getOwnerComponent().getModel(),                                                                                                                                                                                                
				that = this,                                                                                                                                                                                                                                               
				oModel,                                                                                                                                                                                                                                                    
				aCode = [];                                                                                                                                                                                                                                                
			oServiceCallModel.read(sServiceURL, {                                                                                                                                                                                                                       
				method: "GET",                                                                                                                                                                                                                                             
				success: function (oData, oResponse) {                                                                                                                                                                                                                     
					aCode = oData.results;                                                                                                                                                                                                                                    
					let oModel = new JSONModel(aCode);                                                                                                                                                                                                                        
					that.getView().setModel(oModel, sModel);                                                                                                                                                                                                                  
				},                                                                                                                                                                                                                                                         
				error: function (oError) {                                                                                                                                                                                                                                 
					MessageToast.show(this.getResourceBundle().getText("errorGetValidatnData"));                                                                                                                                                                              
				}                                                                                                                                                                                                                                                          
			});                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                               
		},                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
		// set header value in the coding block fields in the line items                                                                                                                                                                                             
		_setValue: function (aItems, sLedgerVal) {                                                                                                                                                                                                                   
			let sComponentContainerId = "",                                                                                                                                                                                                                             
				sId,                                                                                                                                                                                                                                                       
				oLedgerGrp,                                                                                                                                                                                                                                                
				oExistingCodingBlockComponent = null;                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                               
			for (var i = 0; i < aItems.length; i++) {                                                                                                                                                                                                                   
				sComponentContainerId = this._getComponentContainerID(aItems, i);                                                                                                                                                                                          
				oExistingCodingBlockComponent = this.byId(sComponentContainerId).getComponentInstance();                                                                                                                                                                   
                                                                                                                                                                                                                                                               
				if (oExistingCodingBlockComponent) {                                                                                                                                                                                                                       
					sId = oExistingCodingBlockComponent.page.getIdForLabel();                                                                                                                                                                                                 
					oLedgerGrp = sap.ui.getCore().byId(sId + "_codingBlockGroupElement_ZZ1_LedgerGroup_COB");                                                                                                                                                                 
					this._validateSetValue(oLedgerGrp, sLedgerVal);                                                                                                                                                                                                           
				}                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
			}                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
		},                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
		//set and validate header value                                                                                                                                                                                                                              
		_validateSetValue: function (oLedgerGrp, sLedgerVal) {                                                                                                                                                                                                       
			let aLedgVal = this.getView().getModel("ledgerGrpVHModel").getData(),                                                                                                                                                                                       
				aItm = aLedgVal.find(itm => itm.Code === sLedgerVal);                                                                                                                                                                                                      
			if (aItm) {                                                                                                                                                                                                                                                 
				let sVal = aItm.Code + " (" + aItm.Description + ")";                                                                                                                                                                                                      
				oLedgerGrp.getInnerControls()[0].setText(sVal);                                                                                                                                                                                                            
			} else {                                                                                                                                                                                                                                                    
				oLedgerGrp.getInnerControls()[0].setText("");                                                                                                                                                                                                              
			}                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
		},                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
		_fetchIntention: function (sFiscYr, sConsUn, oSpecialPrd) {                                                                                                                                                                                                  
			let oModel = this.getOwnerComponent().getModel("oAppServicesModel"),                                                                                                                                                                                        
				sVal,                                                                                                                                                                                                                                                      
				oView = this.getView(),                                                                                                                                                                                                                                    
				that = this;                                                                                                                                                                                                                                               
			oView.setBusyIndicatorDelay(-1).setBusy(true);                                                                                                                                                                                                              
			oModel.read("/xEY1xC_INTENTIONS_VH(p_bunit='" + sConsUn + "',p_gjahr='" + sFiscYr + "')/Set", {                                                                                                                                                             
				method: "GET",                                                                                                                                                                                                                                             
				success: function (oData, oResponse) {                                                                                                                                                                                                                     
					oView.setBusy(false);                                                                                                                                                                                                                                     
					if (oData.results.length > 0) {                                                                                                                                                                                                                           
						sVal = oData.results[0].Description + " (" + oData.results[0].IntentionCode + ")";                                                                                                                                                                       
					}                                                                                                                                                                                                                                                         
					oSpecialPrd.getInnerControls()[0].setText(sVal);                                                                                                                                                                                                          
				},                                                                                                                                                                                                                                                         
				error: function (oError) {                                                                                                                                                                                                                                 
					oView.setBusy(true);                                                                                                                                                                                                                                      
					MessageToast.show(this.getResourceBundle().getText("errorGetTaxIntData"));                                                                                                                                                                                
				}                                                                                                                                                                                                                                                          
			});                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                               
		},                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
		/**                                                                                                                                                                                                                                                          
		 * CreateCodingBlock: Create Coding Block and assign it to corresponding item                                                                                                                                                                                
		 * @param indexOfLineItem - guess                                                                                                                                                                                                                            
		 * @param sAction: 'E' for expand line item, 'D' for delete line item                                                                                                                                                                                        
		 */                                                                                                                                                                                                                                                          
		createCodingBlock: function (indexOfLineItem, sAction) {                                                                                                                                                                                                     
			var sItemLength;                                                                                                                                                                                                                                            
			var bCreateComponent;                                                                                                                                                                                                                                       
			var oView = this.getView();                                                                                                                                                                                                                                 
			var bCodingBlockEditEnabled = true;                                                                                                                                                                                                                         
			var sTmpId = this.oModel.getProperty("TmpId", oView.getBindingContext());                                                                                                                                                                                   
			var sTmpIdType = this.oModel.getProperty("TmpIdType", oView.getBindingContext());                                                                                                                                                                           
			var sComponentContainerId = "";                                                                                                                                                                                                                             
			var oExistingCodingBlockComponent = null;                                                                                                                                                                                                                   
			var oItemContext = null;                                                                                                                                                                                                                                    
			var sItemRef = "";                                                                                                                                                                                                                                          
			var oCodingBlockComponent = null;                                                                                                                                                                                                                           
			var aItems = this.byId("sap.fin.gl.lib.posting.items").getItems();                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
			// expand action alway expand only one line item                                                                                                                                                                                                            
			if (sAction === Constants.LINE_ITEM_EXPAND) {                                                                                                                                                                                                               
				sItemLength = indexOfLineItem + 1;                                                                                                                                                                                                                         
			} else if (sAction === Constants.LINE_ITEM_DELETE) {                                                                                                                                                                                                        
				sItemLength = aItems.length;                                                                                                                                                                                                                               
			}                                                                                                                                                                                                                                                           
			// Update labels of coding block amount fields if necessary                                                                                                                                                                                                 
			var oHeader = this.oModel.getProperty(oView.getBindingContext().getPath());                                                                                                                                                                                 
			var oCBAttributeLabels = this.getCBAttributeLabelsObject(oHeader);                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
			let aLedgVal = oView.getModel("ledgerGrpVHModel").getData();                                                                                                                                                                                                
                                                                                                                                                                                                                                                               
			if (sTmpIdType === Constants.RECURRING_TYPE || sTmpIdType === Constants.PARKED_TYPE) {                                                                                                                                                                      
				// Displayed Recurring Journal Entries have an additional "R"                                                                                                                                                                                              
				bCodingBlockEditEnabled = false;                                                                                                                                                                                                                           
			}                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
			for (var i = indexOfLineItem; i < sItemLength; i++) {                                                                                                                                                                                                       
                                                                                                                                                                                                                                                               
				sComponentContainerId = this._getComponentContainerID(aItems, i);                                                                                                                                                                                          
				oExistingCodingBlockComponent = this.byId(sComponentContainerId).getComponentInstance();                                                                                                                                                                   
                                                                                                                                                                                                                                                               
				if (sAction === Constants.LINE_ITEM_EXPAND && !oExistingCodingBlockComponent) {                                                                                                                                                                            
					bCreateComponent = true;                                                                                                                                                                                                                                  
				} else if (sAction === Constants.LINE_ITEM_DELETE) {                                                                                                                                                                                                       
					bCreateComponent = true;                                                                                                                                                                                                                                  
				}                                                                                                                                                                                                                                                          
				if (bCreateComponent) {                                                                                                                                                                                                                                    
					oItemContext = aItems[i].getBindingContext();                                                                                                                                                                                                             
					sItemRef = oItemContext.getProperty("AccountingDocumentItemRef");                                                                                                                                                                                         
					oCodingBlockComponent = sap.ui.getCore().createComponent({                                                                                                                                                                                                
						"name": "sap.fin.acc.lib.codingblock.component",                                                                                                                                                                                                         
						componentData: {                                                                                                                                                                                                                                         
							"entitySetName": "FinsPostingGLItems",                                                                                                                                                                                                                  
							"entityKey": {                                                                                                                                                                                                                                          
								"AccountingDocumentItemRef": sItemRef,                                                                                                                                                                                                                 
								"TmpId": sTmpId,                                                                                                                                                                                                                                       
								"TmpIdType": sTmpIdType                                                                                                                                                                                                                                
							},                                                                                                                                                                                                                                                      
							"attributeLabels": oCBAttributeLabels,                                                                                                                                                                                                                  
							"editMode": bCodingBlockEditEnabled,                                                                                                                                                                                                                    
							"enableProfitabilitySegment": true,                                                                                                                                                                                                                     
							"profitabilitySegmentEntitySetName": "FinsPostingGLItemProfitbltySgmts",                                                                                                                                                                                
							"profitabilitySegmentFunctionImports": {                                                                                                                                                                                                                
								"CHECK": "CheckAndDetermine",                                                                                                                                                                                                                          
								"OPEN": "ProfitabilitySegmentOpen",                                                                                                                                                                                                                    
								"DERIVE": "ProfitabilitySegmentDerive",                                                                                                                                                                                                                
								"DERIVECLOSE": "ProfitabilitySegmentDeriveAndClose",                                                                                                                                                                                                   
								"CLOSE": "ProfitabilitySegmentClose",                                                                                                                                                                                                                  
								"DELETE": "ProfitabilitySegmentDelete"                                                                                                                                                                                                                 
							}                                                                                                                                                                                                                                                       
						}                                                                                                                                                                                                                                                        
					});                                                                                                                                                                                                                                                       
					// Register Events&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                                                            
					oCodingBlockComponent.attachCodingBlockAttributeChanged(jQuery.proxy(this.onCodingBlockChange, this));                                                                                                                                                    
					//					oCodingBlockComponent.attachProfitabilitySegmentAttributeChanged(jQuery.proxy(this.onCodingBlockChange, this));                                                                                                                                    
					oCodingBlockComponent.attachEnterPressed(jQuery.proxy(this.onsapenter, this));                                                                                                                                                                            
                                                                                                                                                                                                                                                               
					//custom extended code to make line items field non editable.....................................................////////////////////////////                                                                                                             
                                                                                                                                                                                                                                                               
					oCodingBlockComponent.onAfterRendering = function () {                                                                                                                                                                                                    
							let sId = this.page.getIdForLabel(),                                                                                                                                                                                                                    
								oLedgerGrp = sap.ui.getCore().byId(sId + "_codingBlockGroupElement_ZZ1_LedgerGroup_COB"),                                                                                                                                                              
								oSpecialPrd = sap.ui.getCore().byId(sId + "_codingBlockGroupElement_ZZ1_TaxIntention_COB"),                                                                                                                                                            
								sLedgerVal = oHeader.LedgerGroup;                                                                                                                                                                                                                      
							//	sPeriodVal = oHeader.FiscalPeriod;                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                               
							oLedgerGrp.setShowValueHelp(false);                                                                                                                                                                                                                     
							oLedgerGrp.setShowSuggestion(false);                                                                                                                                                                                                                    
							oLedgerGrp.setEnabled(false);                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
							oSpecialPrd.setShowValueHelp(false);                                                                                                                                                                                                                    
							oSpecialPrd.setShowSuggestion(false);                                                                                                                                                                                                                   
							oSpecialPrd.setEnabled(false);                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
							let aItm = aLedgVal.find(itm => itm.Code === sLedgerVal);                                                                                                                                                                                               
							if (aItm) {                                                                                                                                                                                                                                             
								let sVal = aItm.Code + " (" + aItm.Description + ")";                                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
								oLedgerGrp.getInnerControls()[0].setText(sVal);                                                                                                                                                                                                        
							} else {                                                                                                                                                                                                                                                
								oLedgerGrp.getInnerControls()[0].setText("");                                                                                                                                                                                                          
							}                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                               
						}                                                                                                                                                                                                                                                        
						////end of custom extended code............................................//////////////////////////////////////////////                                                                                                                                
					this.byId(sComponentContainerId).setComponent(oCodingBlockComponent);                                                                                                                                                                                     
					this.sCompanyCodeForCodingBlockLabels = oHeader.CompanyCode;                                                                                                                                                                                              
					this._sLedgerGroupForCodingBlockLabels = oHeader.LedgerGroup;                                                                                                                                                                                             
				}                                                                                                                                                                                                                                                          
			}                                                                                                                                                                                                                                                           
		},                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
		onHeaderChanged: function (E) {                                                                                                                                                                                                                              
			this._bKeyFieldsChanged = true;                                                                                                                                                                                                                             
			this._checkAllMandatoryFilled();                                                                                                                                                                                                                            
			var p = E.getParameters();                                                                                                                                                                                                                                  
			if ((p.id.match("[A-Za-z]*(sfHeaderCompanyCode){1}")) || (p.id.match("[A-Za-z]*(sfHeaderTransactionCurrency){1}")) || (p.id.match(                                                                                                                          
					"[A-Za-z]*(sfHeaderLedgerGroup){1}"))) {                                                                                                                                                                                                                  
				this.fillBalanceTableEntries();                                                                                                                                                                                                                            
				this.computeBalance();                                                                                                                                                                                                                                     
			}                                                                                                                                                                                                                                                           
			if (p.id.match("[A-Za-z]*(sfHeaderTransactionCurrency){1}")) {                                                                                                                                                                                              
				this.updateTransactionCurrencyOnItem();                                                                                                                                                                                                                    
			}                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
			//custome extended code.....................................................//////////////////////                                                                                                                                                          
			let oHeader = this.getOwnerComponent().getModel().getProperty(this.getView().getBindingContext().getPath()),                                                                                                                                                
				sLedgerVal = oHeader.LedgerGroup,                                                                                                                                                                                                                          
				aItems = this.byId("sap.fin.gl.lib.posting.items").getItems();                                                                                                                                                                                             
                                                                                                                                                                                                                                                               
			this._setValue(aItems, sLedgerVal);                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                               
		},                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
		submitChanges: function (oControl, fnSuccess, fnError, bExpand) {                                                                                                                                                                                            
                                                                                                                                                                                                                                                               
			//custom extended code................................./////////////////////////////////                                                                                                                                                                    
			let oControlVal = oControl,                                                                                                                                                                                                                                 
				that = this,                                                                                                                                                                                                                                               
				sId = oControlVal.getContent()[0].getComponentInstance().page.getIdForLabel();                                                                                                                                                                             
			this.oModel.attachRequestCompleted({                                                                                                                                                                                                                        
				'sId': sId,                                                                                                                                                                                                                                                
				'oControl': that                                                                                                                                                                                                                                           
			}, fnRequestCompleted, this);                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
			function fnRequestCompleted(oEvent, oParam) {                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
				let oSpecialPrd = sap.ui.getCore().byId(oParam.sId + "_codingBlockGroupElement_ZZ1_TaxIntention_COB"),                                                                                                                                                     
					aEntitysetName = oEvent.getParameters().url.split("("),                                                                                                                                                                                                   
					oControl = oParam.oControl;                                                                                                                                                                                                                               
				if (oSpecialPrd) {                                                                                                                                                                                                                                         
					if (aEntitysetName[0] === "FinsPostingGLHeaders" && oEvent.getParameters().method === "GET") {                                                                                                                                                            
						let spath = oEvent.getParameters().url.split('?'),                                                                                                                                                                                                       
							sFiscYr = oEvent.getSource().getProperty(sPath + "/FiscalYear"),                                                                                                                                                                                        
							sConsUn = oEvent.getSource().getProperty(sPath + "/CompanyCode");                                                                                                                                                                                       
						console.log(oControl);                                                                                                                                                                                                                                   
						console.log(sFiscYr);                                                                                                                                                                                                                                    
						console.log(sConsUn);                                                                                                                                                                                                                                    
						oControl._fetchIntention(sFiscYr, sConsUn, oSpecialPrd);                                                                                                                                                                                                 
					}                                                                                                                                                                                                                                                         
				}                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
			}                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
			// handle erroneous submit                                                                                                                                                                                                                                  
			//			var fnSubmitError = jQuery.proxy(function(mValidationResult) {                                                                                                                                                                                         
			//				if (fnError) {                                                                                                                                                                                                                                        
			//					fnError();                                                                                                                                                                                                                                           
			//				}                                                                                                                                                                                                                                                     
			//			}, this);                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
			// handle successful submit                                                                                                                                                                                                                                 
			var fnSubmitSuccess = jQuery.proxy(function () {                                                                                                                                                                                                            
				////custom extended code....................//////////////////////////                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
				var oSmartTableTax = this.byId("sap.fin.gl.lib.posting.smartTableTax");                                                                                                                                                                                    
				if (oSmartTableTax) {                                                                                                                                                                                                                                      
					//it has to set as 'true', otherwise the data will not rebind correctly                                                                                                                                                                                   
					//internal incident 1670370204                                                                                                                                                                                                                            
					oSmartTableTax.rebindTable(true);                                                                                                                                                                                                                         
				}                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
				// // Fix bug in Recurring                                                                                                                                                                                                                                 
				// var oRecurrenceRule = this.byId("sap.fin.gl.recurringjournalentries.manage.sectionTaxy");                                                                                                                                                               
				// if (oRecurrenceRule) {                                                                                                                                                                                                                                  
				// 	this._checkAllMandatoryFilled();&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                                                                         
				// }                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                               
				if (this.mEntityMap.hasOwnProperty("RecrrgAcctgDocOccurrence")) {                                                                                                                                                                                          
					var oRecurPostingsTable = this.byId(this.mEntityMap.RecrrgAcctgDocOccurrence.containerId);                                                                                                                                                                
					if (oRecurPostingsTable) {                                                                                                                                                                                                                                
						oRecurPostingsTable.rebindTable();                                                                                                                                                                                                                       
					}                                                                                                                                                                                                                                                         
				}                                                                                                                                                                                                                                                          
				if (fnSuccess) {                                                                                                                                                                                                                                           
					fnSuccess();                                                                                                                                                                                                                                              
				}                                                                                                                                                                                                                                                          
			}, this);                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                               
			// Check and Determine                                                                                                                                                                                                                                      
			this.addActionCheckAndDetermine(oControl.getBindingContext());                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
			// Get all dependent entities with expand excluding pending changes                                                                                                                                                                                         
			// (where GET requests are triggered automatically)                                                                                                                                                                                                         
			var sPath = this.getView().getBindingContext().getPath();                                                                                                                                                                                                   
			var sExpand = "";                                                                                                                                                                                                                                           
			var oPendingChanges = this.oModel.getPendingChanges();                                                                                                                                                                                                      
			jQuery.each(oPendingChanges, jQuery.proxy(function (iKey, oChange) {                                                                                                                                                                                        
				if (iKey.indexOf("FinsPostingGLItems") !== -1) {                                                                                                                                                                                                           
					sExpand = "RecrrgAcctgDocPostingLists,RecurrenceDefinition,Tax";                                                                                                                                                                                          
				} else if (iKey.indexOf("FinsPostingTaxes") !== -1) {                                                                                                                                                                                                      
					sExpand = "Items,RecrrgAcctgDocPostingLists,RecurrenceDefinition";                                                                                                                                                                                        
				} else if (iKey.indexOf("RecurrenceDefinitions") !== -1) {                                                                                                                                                                                                 
					sExpand = "Items,RecrrgAcctgDocPostingLists,Tax";                                                                                                                                                                                                         
				} else if (iKey.indexOf("RecrrgAcctgDocOccurrences") !== -1) {                                                                                                                                                                                             
					sExpand = "Items,RecurrenceDefinition,Tax";                                                                                                                                                                                                               
				} else {                                                                                                                                                                                                                                                   
					sExpand = "Items,RecrrgAcctgDocPostingLists,RecurrenceDefinition,Tax";                                                                                                                                                                                    
				}                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
			}, this));                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
			var mParametersRead;                                                                                                                                                                                                                                        
			if (sExpand !== "") {                                                                                                                                                                                                                                       
				mParametersRead = {                                                                                                                                                                                                                                        
					urlParameters: {                                                                                                                                                                                                                                          
						"$expand": sExpand                                                                                                                                                                                                                                       
					},                                                                                                                                                                                                                                                        
					groupId: "DEFAULT"                                                                                                                                                                                                                                        
				};                                                                                                                                                                                                                                                         
				this.oModel.read(sPath, mParametersRead);                                                                                                                                                                                                                  
			} else if (bExpand) {                                                                                                                                                                                                                                       
				var sPathItem = sPath + "/Items";                                                                                                                                                                                                                          
				mParametersRead = {                                                                                                                                                                                                                                        
					urlParameters: {},                                                                                                                                                                                                                                        
					groupId: "DEFAULT"                                                                                                                                                                                                                                        
				};                                                                                                                                                                                                                                                         
				this.oModel.read(sPathItem, mParametersRead);                                                                                                                                                                                                              
			}                                                                                                                                                                                                                                                           
			// submit changes                                                                                                                                                                                                                                           
			this.submitRequests(fnSubmitSuccess, fnError);                                                                                                                                                                                                              
		}                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                               
	});                                                                                                                                                                                                                                                           
	return P;                                                                                                                                                                                                                                                     
});                                                                                                                                                                                                                                                            